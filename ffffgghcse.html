<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½ä½“å¯¹è¯ä¸­å¿ƒ</title>
  <!-- å¼•å…¥å¤–éƒ¨èµ„æº -->
  <!-- æ³¨æ„ï¼šTailwind CSS CDN ä»…ç”¨äºå¼€å‘å’ŒåŸå‹è®¾è®¡ï¼Œç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ PostCSS æ’ä»¶æˆ– Tailwind CLI -->
  <!-- è¯¦è§ï¼šhttps://tailwindcss.com/docs/installation -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Markdownæ¸²æŸ“åº“ - ä½¿ç”¨å¤‡ç”¨CDN -->
  <script src="https://unpkg.com/marked@9.1.6/marked.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js'"></script>
  <script src="https://unpkg.com/dompurify@3.0.5/dist/purify.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js'"></script>
  
  <!-- é…ç½®Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5', // ä¸»è‰²è°ƒï¼šé›è“è‰²
            secondary: '#10B981', // è¾…åŠ©è‰²ï¼šç»¿è‰²
            neutral: {
              100: '#F3F4F6',
              200: '#E5E7EB',
              700: '#374151',
              800: '#1F2937',
              900: '#111827'
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      #messageInput::-webkit-scrollbar {
        display: none;
      }
      .settings-scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      select option {
        border-radius: 8px;
        margin: 2px;
        padding: 8px;
      }
      select optgroup {
        border-radius: 8px;
        margin: 2px;
      }
      .animate-float {
        animation: float 6s ease-in-out infinite;
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      .animate-slide-up {
        animation: slideUp 0.3s ease-out;
      }
      .animate-pulse-slow {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .animate-bounce-subtle {
        animation: bounceSubtle 1s ease-in-out infinite;
      }
      .typing-indicator {
        animation: typing 1.4s infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes bounceSubtle {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
      }
      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
      }
      .glass-effect {
        backdrop-filter: blur(5px);
        background: transparent;
      }
      .gradient-border {
        background: linear-gradient(45deg, #4F46E5, #10B981);
        padding: 2px;
        border-radius: 12px;
      }
      .gradient-border > div {
        background: white;
        border-radius: 10px;
      }
      /* Markdownæ ·å¼ */
      .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        font-weight: bold;
        margin: 1em 0 0.5em 0;
        line-height: 1.2;
      }
      .markdown-content h1 { font-size: 1.5em; }
      .markdown-content h2 { font-size: 1.3em; }
      .markdown-content h3 { font-size: 1.2em; }
      .markdown-content h4 { font-size: 1.1em; }
      .markdown-content p {
        margin: 0.5em 0;
        line-height: 1.6;
      }
      .markdown-content ul, .markdown-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
      }
      .markdown-content li {
        margin: 0.25em 0;
      }
      .markdown-content blockquote {
        border-left: 4px solid #4F46E5;
        padding-left: 1em;
        margin: 1em 0;
        background: #f8fafc;
        border-radius: 0 8px 8px 0;
      }
      .markdown-content code {
        background: #f1f5f9;
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
      }
      .markdown-content pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1em;
        border-radius: 0 0 8px 8px;
        overflow-x: auto;
        margin: 0;
      }
      .markdown-content pre code {
        background: none;
        padding: 0;
        color: inherit;
      }
      
      /* ä»£ç å—å®¹å™¨æ ·å¼ */
      .code-block-container {
        margin: 1em 0;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        max-width: 100%;
      }
      
      .code-block-container pre {
        margin: 0;
        padding: 1em;
        background: #1f2937;
        color: #f9fafb;
        font-family: 'Courier New', Consolas, Monaco, monospace;
        font-size: 0.875em;
        line-height: 1.5;
        overflow-x: auto;
        max-width: 100%;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      
      .code-block-container code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        color: inherit;
        white-space: pre-wrap;
        word-wrap: break-word;
        display: block;
      }
      
      .code-block-header {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      .code-language {
        font-weight: 500;
        color: #374151;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }
      
      .copy-code-btn {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        border: none;
        cursor: pointer;
        font-weight: 500;
      }
      
      .copy-code-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .markdown-content table, .markdown-content .markdown-table {
        border-collapse: collapse;
        width: 100%;
        margin: 1em 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .markdown-content th, .markdown-content td {
        border: 1px solid #e2e8f0;
        padding: 12px 16px;
        text-align: left;
        vertical-align: top;
      }
      .markdown-content th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
      }
      .markdown-content tr:nth-child(even) {
        background: #f9fafb;
      }
      .markdown-content tr:hover {
        background: #f3f4f6;
      }
      .markdown-content hr {
        border: none;
        height: 2px;
        background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
        margin: 2em 0;
      }
      .markdown-content strong {
        font-weight: 700;
        color: #1f2937;
      }
      .markdown-content em {
        font-style: italic;
        color: #4b5563;
      }
      .markdown-content u {
        text-decoration: underline;
        text-decoration-color: #6366f1;
      }
      .markdown-content s, .markdown-content del, .markdown-content strike {
         text-decoration: line-through;
         color: #9ca3af;
       }
      .markdown-content a {
        color: #4f46e5;
      }
      /* æ¶ˆæ¯æ°”æ³¡ä¼˜åŒ–æ ·å¼ */
      .message-bubble {
        word-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
        min-height: 1.5em;
        display: flex;
        align-items: center;
        /* è¶…è¿‡41å­—ç¬¦è‡ªåŠ¨æ¢è¡Œ */
        max-width: 41ch;
        overflow-wrap: break-word;
        hyphens: auto;
      }
      .user-message {
        text-align: left;
        justify-content: flex-start;
      }
      .ai-message {
        text-align: left;
        justify-content: flex-start;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: all 0.2s ease;
      }
      .markdown-content a:hover {
        color: #3730a3;
        border-bottom-color: #4f46e5;
      }
      .markdown-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1em 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .markdown-content del {
        text-decoration: line-through;
        color: #9ca3af;
      }
      .markdown-content mark {
        background: #fef3c7;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .markdown-content kbd {
         background: #f3f4f6;
         border: 1px solid #d1d5db;
         border-radius: 4px;
         padding: 2px 6px;
         font-family: monospace;
         font-size: 0.875em;
         box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
       }
       .markdown-content sup {
         font-size: 0.75em;
         vertical-align: super;
         line-height: 0;
       }
       .markdown-content sub {
          font-size: 0.75em;
          vertical-align: sub;
          line-height: 0;
        }
        
        /* æµå¼è¾“å‡ºå…‰æ ‡åŠ¨ç”» */
        .typing-cursor {
          display: inline-block;
          width: 3px;
          height: 1.2em;
          background: linear-gradient(45deg, #6366f1, #8b5cf6);
          margin-left: 2px;
          border-radius: 2px;
          animation: cursor-blink 1.2s infinite;
        }
        
        .typing-dots {
          display: inline-flex;
          align-items: center;
          gap: 2px;
          margin-left: 4px;
        }
        
        .typing-dot {
          width: 4px;
          height: 4px;
          background: #6366f1;
          border-radius: 50%;
          animation: dot-bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes cursor-blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
        }
        
        @keyframes dot-bounce {
          0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
          }
          40% {
            transform: scale(1.2);
            opacity: 1;
          }
        }
        
        .typing-cursor {
          display: inline-block;
          font-weight: bold;
          margin-left: 2px;
          font-size: 1.2em;
          color: #ff6b6b;
          animation: rainbow-color 2s ease-in-out infinite, pulse-scale 1.5s ease-in-out infinite alternate;
          text-rendering: optimizeLegibility;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes rainbow-color {
          0% { color: #ff6b6b; }
          16.66% { color: #4ecdc4; }
          33.33% { color: #45b7d1; }
          50% { color: #96ceb4; }
          66.66% { color: #feca57; }
          83.33% { color: #ff9ff3; }
          100% { color: #ff6b6b; }
        }
        
        @keyframes pulse-scale {
          0% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
          }
          50% {
            transform: scale(1.15) rotate(2deg);
            opacity: 0.8;
          }
          100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
          }
        }
      }
      
      /* æ¨ç†è¿‡ç¨‹æ ·å¼ */
      .reasoning-container {
        transition: all 0.2s ease-out;
      }
      
      .reasoning-section {
        animation: fadeInUp 0.3s ease-out;
        transition: all 0.1s ease-out;
      }
      
      .reasoning-content {
        transition: opacity 0.1s ease-out;
        will-change: contents;
        backface-visibility: hidden;
        transform: translateZ(0);
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .reasoning-section .text-blue-700 {
        line-height: 1.5;
        font-family: 'Courier New', monospace;
      }
      
      /* å‡å°‘é—ªçƒçš„ä¼˜åŒ– */
      .markdown-content {
        transition: none;
      }
      
      /* æµå¼è¾“å‡ºä¼˜åŒ– */
      .typing-dots {
        opacity: 0.7;
        animation: pulse 1.5s ease-in-out infinite;
      }
      
      /* æ¨ç†å®¹å™¨å±•å¼€/æ”¶èµ·åŠ¨ç”» */
      .reasoning-container {
        transition: all 0.3s ease;
      }
      
      .reasoning-section {
        transition: max-height 0.3s ease, opacity 0.3s ease;
        overflow: hidden;
      }
      
      .reasoning-content {
        transition: opacity 0.3s ease;
      }
      
      .reasoning-toggle-btn {
        transition: transform 0.2s ease;
      }
      
      .reasoning-toggle-btn:hover {
        transform: scale(1.1);
      }
      
      .reasoning-toggle-btn i {
        transition: transform 0.3s ease;
      }
    </style>
</head>

<body class="font-inter bg-neutral-100 text-neutral-800 min-h-screen flex flex-col">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <header class="glass-effect shadow-lg fixed top-0 left-0 right-0 z-50 transition-all duration-300 border-b border-neutral-200/50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-primary text-2xl animate-bounce-subtle">
          <i class="fa fa-comments-o"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-neutral-800">æ™ºèƒ½å¯¹è¯åŠ©æ‰‹</h1>
          <div class="flex items-center gap-2 text-xs text-neutral-500">
            <div id="connectionStatus" class="flex items-center gap-1">
              <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse-slow"></div>
              <span>å·²è¿æ¥</span>
            </div>
            <span>â€¢</span>
            <span id="messageCount">0 æ¡æ¶ˆæ¯</span>
          </div>
        </div>
      </div>
      
      <div class="flex items-center gap-2">
        <!-- å¿«æ·åŠŸèƒ½æŒ‰é’® -->
        <button id="clearChatBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors" title="æ¸…ç©ºå¯¹è¯">
          <i class="fa fa-trash-o text-neutral-700"></i>
        </button>
        <button id="exportChatBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors" title="å¯¼å‡ºå¯¹è¯">
          <i class="fa fa-download text-neutral-700"></i>
        </button>
        <button id="fullscreenBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors" title="å…¨å±æ¨¡å¼">
          <i class="fa fa-expand text-neutral-700"></i>
        </button>
        <div class="w-px h-6 bg-neutral-300 mx-1"></div>
        <button id="settingsBtn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors" title="è®¾ç½®">
          <i class="fa fa-cog text-neutral-700"></i>
        </button>
        <button id="themeToggle" class="p-2 rounded-full hover:bg-neutral-100 transition-colors" title="åˆ‡æ¢ä¸»é¢˜">
          <i class="fa fa-moon-o text-neutral-700"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="flex-1 pt-16 pb-32 px-4 md:px-6 container mx-auto max-w-4xl">
    <!-- å¯¹è¯åŒºåŸŸ -->
    <div id="chatContainer" class="space-y-6 py-6">
      <!-- æ¬¢è¿æ¶ˆæ¯ -->
      <div id="welcomeMessage" class="text-center py-12 animate-fade-in">
        <div class="text-6xl text-primary mb-4 animate-float">
          <i class="fa fa-robot"></i>
        </div>
        <h2 class="text-2xl font-bold text-neutral-800 mb-2">æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å¯¹è¯åŠ©æ‰‹</h2>
        <p class="text-neutral-600 mb-6">æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è§£ç­”é—®é¢˜ã€æä¾›å»ºè®®å’Œè¿›è¡Œæœ‰è¶£çš„å¯¹è¯</p>
        
        <!-- åŠŸèƒ½æ ‡ç­¾ -->
        <div class="flex flex-wrap justify-center gap-2 mb-8">
          <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors cursor-pointer">é—®ç­”åŠ©æ‰‹</span>
          <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors cursor-pointer">åˆ›æ„å†™ä½œ</span>
          <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors cursor-pointer">ä»£ç å¸®åŠ©</span>
          <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm hover:bg-primary/20 transition-colors cursor-pointer">å­¦ä¹ è¾…å¯¼</span>
        </div>
        
        <!-- å¿«é€Ÿå¼€å§‹å»ºè®® -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
          <div class="suggestion-card p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer border border-neutral-200 hover:border-primary/30">
            <div class="text-primary text-xl mb-2"><i class="fa fa-lightbulb-o"></i></div>
            <h3 class="font-semibold text-neutral-800 mb-1">åˆ›æ„çµæ„Ÿ</h3>
            <p class="text-sm text-neutral-600">å¸®æˆ‘æƒ³ä¸€ä¸ªæœ‰è¶£çš„æ•…äº‹å¼€å¤´</p>
          </div>
          <div class="suggestion-card p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer border border-neutral-200 hover:border-primary/30">
            <div class="text-primary text-xl mb-2"><i class="fa fa-code"></i></div>
            <h3 class="font-semibold text-neutral-800 mb-1">ç¼–ç¨‹åŠ©æ‰‹</h3>
            <p class="text-sm text-neutral-600">è§£é‡Šä¸€ä¸‹JavaScriptçš„é—­åŒ…æ¦‚å¿µ</p>
          </div>
          <div class="suggestion-card p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer border border-neutral-200 hover:border-primary/30">
            <div class="text-primary text-xl mb-2"><i class="fa fa-book"></i></div>
            <h3 class="font-semibold text-neutral-800 mb-1">å­¦ä¹ æŒ‡å¯¼</h3>
            <p class="text-sm text-neutral-600">åˆ¶å®šä¸€ä¸ªå­¦ä¹ è®¡åˆ’</p>
          </div>
          <div class="suggestion-card p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer border border-neutral-200 hover:border-primary/30">
            <div class="text-primary text-xl mb-2"><i class="fa fa-question-circle"></i></div>
            <h3 class="font-semibold text-neutral-800 mb-1">é—®é¢˜è§£ç­”</h3>
            <p class="text-sm text-neutral-600">å›ç­”æˆ‘çš„ä»»ä½•ç–‘é—®</p>
          </div>
        </div>
      </div>
      
      <!-- åŠ¨æ€ç”Ÿæˆçš„å¯¹è¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
  </main>

  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <footer class="fixed bottom-0 left-0 right-0 glass-effect border-t border-neutral-200/50 p-4 z-40">
    <div class="container mx-auto max-w-4xl">
      <!-- å¿«æ·å›å¤å»ºè®® -->
      <div id="quickReplies" class="hidden mb-3">
        <div class="flex gap-2 overflow-x-auto scrollbar-hide pb-2">
          <button class="quick-reply-btn px-3 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-sm whitespace-nowrap transition-colors">ç»§ç»­</button>
          <button class="quick-reply-btn px-3 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-sm whitespace-nowrap transition-colors">è¯¦ç»†è§£é‡Š</button>
          <button class="quick-reply-btn px-3 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-sm whitespace-nowrap transition-colors">ä¸¾ä¸ªä¾‹å­</button>
          <button class="quick-reply-btn px-3 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-sm whitespace-nowrap transition-colors">æ¢ä¸ªæ–¹å¼</button>
          <button class="quick-reply-btn px-3 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-sm whitespace-nowrap transition-colors">æ€»ç»“ä¸€ä¸‹</button>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <!-- åŠŸèƒ½æŒ‰é’® -->
        <div class="flex gap-2">
          <button id="toolsBtn" class="p-3 rounded-full bg-neutral-200 text-neutral-700 hover:bg-neutral-300 transition-all duration-300 hover:scale-105" title="å·¥å…·">
            <i class="fa fa-wrench"></i>
          </button>
        </div>
        
        <!-- è¾“å…¥æ¡† -->
        <div class="flex-1 relative gradient-border">
          <div class="relative">
            <textarea 
              id="messageInput" 
              placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (æ”¯æŒ Markdown æ ¼å¼)" 
              class="w-full px-4 py-3 pr-20 border-0 rounded-xl resize-none focus:outline-none transition-all bg-transparent"
              rows="1"
              style="height: 100%; width: 100%; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; overflow: auto; overflow-wrap: break-word; hyphens: auto; box-sizing: border-box; resize: none; scrollbar-width: none; -ms-overflow-style: none;"
            ></textarea>
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center gap-1">
              <button id="attachmentBtn" class="p-1.5 rounded-full hover:bg-neutral-100 transition-colors" title="æ·»åŠ é™„ä»¶">
                <i class="fa fa-paperclip text-neutral-500 text-sm"></i>
              </button>
              <button id="voiceBtn" class="p-1.5 rounded-full hover:bg-neutral-100 transition-colors" title="è¯­éŸ³è¾“å…¥">
                <i class="fa fa-microphone text-neutral-500 text-sm"></i>
              </button>
              <button id="sendBtn" class="p-2 rounded-full bg-primary text-white hover:bg-primary/90 transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                <i class="fa fa-paper-plane-o"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- çŠ¶æ€æ  -->
      <div class="flex items-center justify-between mt-3 text-xs text-neutral-500">
        <div class="flex items-center gap-4">
          <span id="charCount" class="font-mono">0/2000</span>
          <span id="modelStatus" class="flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
            æ¨¡å‹: æœªé…ç½®
          </span>
          <span id="typingIndicator" class="hidden flex items-center gap-1">
            <div class="flex gap-1">
              <div class="w-1 h-1 bg-primary rounded-full typing-indicator" style="animation-delay: 0s"></div>
              <div class="w-1 h-1 bg-primary rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
              <div class="w-1 h-1 bg-primary rounded-full typing-indicator" style="animation-delay: 0.4s"></div>
            </div>
            AIæ­£åœ¨æ€è€ƒ...
          </span>
        </div>
        <div class="flex items-center gap-4 text-neutral-400">
          <span class="hidden md:inline">Ctrl+Enter å‘é€</span>
          <span class="hidden md:inline">â€¢</span>
          <span class="hidden md:inline">Shift+Enter æ¢è¡Œ</span>
          <span class="md:hidden">å¿«æ·é”®</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- è®¾ç½®é¢æ¿ (é»˜è®¤éšè—) -->
  <div id="settingsPanel" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 animate-fade-in">
    <div class="rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up settings-scrollbar-hide" style="background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); scrollbar-width: none; -ms-overflow-style: none;">
      <div class="p-6 border-b border-neutral-200 flex justify-between items-center bg-gradient-to-r from-primary/5 to-primary/10">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center">
            <i class="fa fa-cog text-primary"></i>
          </div>
          <h2 class="text-xl font-bold text-neutral-800">ç³»ç»Ÿè®¾ç½®</h2>
        </div>
        <button id="closeSettings" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
          <i class="fa fa-times text-neutral-700"></i>
        </button>
      </div>
      
      <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
      <div class="border-b border-neutral-200">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
          <button class="settings-tab active py-4 px-1 border-b-2 border-primary text-primary font-medium text-sm rounded-t-lg" data-tab="model">
            <i class="fa fa-robot mr-2"></i>æ¨¡å‹é…ç½®
          </button>
          <button class="settings-tab py-4 px-1 border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 font-medium text-sm rounded-t-lg" data-tab="features">
            <i class="fa fa-cogs mr-2"></i>åŠŸèƒ½è®¾ç½®
          </button>
          <button class="settings-tab py-4 px-1 border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 font-medium text-sm rounded-t-lg" data-tab="tools">
            <i class="fa fa-wrench mr-2"></i>å·¥å…·ç®¡ç†
          </button>
          <button class="settings-tab py-4 px-1 border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 font-medium text-sm rounded-t-lg" data-tab="advanced">
            <i class="fa fa-sliders mr-2"></i>é«˜çº§è®¾ç½®
          </button>
        </nav>
      </div>
      
      <div class="p-6">
        <!-- æ¨¡å‹é…ç½®æ ‡ç­¾é¡µ -->
        <div id="modelTab" class="settings-content">
          <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center gap-2 text-blue-800 mb-2">
                <i class="fa fa-info-circle"></i>
                <span class="font-medium">é…ç½®æç¤º</span>
              </div>
              <p class="text-blue-700 text-sm">è¯·é€‰æ‹©æ‚¨è¦ä½¿ç”¨çš„AIæ¨¡å‹å¹¶é…ç½®ç›¸åº”çš„APIå¯†é’¥ã€‚æ”¯æŒå¤šç§ä¸»æµæ¨¡å‹æä¾›å•†ã€‚</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">æ¨¡å‹æä¾›å•†</label>
                <select id="modelSelect" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                  <option value="openai">ğŸ¤– OpenAI (GPTç³»åˆ—)</option>
                  <option value="anthropic">ğŸ§  Anthropic (Claude)</option>
                  <option value="deepseek">ğŸ§  DeepSeek</option>
                  <option value="google">ğŸ” Google (Gemini)</option>
                  <option value="xai">ğŸš€ xAI (Grok)</option>
                  <option value="mistral">ğŸŒŸ Mistral AI</option>
                  <option value="cohere">ğŸ’« Cohere</option>
                  <option value="perplexity">ğŸ”® Perplexity</option>
                  <option value="together">ğŸ¤ Together AI</option>
                  <option value="groq">âš¡ Groq</option>
                  <option value="fireworks">ğŸ† Fireworks AI</option>
                  <option value="baidu">ğŸ» ç™¾åº¦ (æ–‡å¿ƒä¸€è¨€)</option>
                  <option value="ali">â˜ï¸ é˜¿é‡Œ (é€šä¹‰åƒé—®)</option>
                  <option value="tencent">ğŸ§ è…¾è®¯ (æ··å…ƒ)</option>
                  <option value="zhipu">ğŸ¤– æ™ºè°± (GLM)</option>
                  <option value="moonshot">ğŸŒ™ æœˆä¹‹æš—é¢ (Kimi)</option>
                  <option value="minimax">ğŸ¯ MiniMax</option>
                  <option value="custom">âš™ï¸ è‡ªå®šä¹‰æ¨¡å‹</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">æ¨¡å‹ç‰ˆæœ¬</label>
                <div class="relative">
                  <select id="modelVersion" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                    <!-- OpenAI æ¨¡å‹ -->
                    <optgroup label="OpenAI">
                      <option value="gpt-4o">GPT-4o</option>
                      <option value="gpt-4o-mini">GPT-4o Mini</option>
                      <option value="gpt-4-turbo">GPT-4 Turbo</option>
                      <option value="gpt-4">GPT-4</option>
                      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                      <option value="o1-preview">o1-preview</option>
                      <option value="o1-mini">o1-mini</option>
                    </optgroup>
                    <!-- Anthropic æ¨¡å‹ -->
                    <optgroup label="Anthropic">
                      <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                      <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                      <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                      <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                      <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    </optgroup>
                    <!-- DeepSeek æ¨¡å‹ -->
                    <optgroup label="DeepSeek">
                      <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                      <option value="deepseek-chat">DeepSeek Chat</option>
                      <option value="deepseek-coder">DeepSeek Coder</option>
                    </optgroup>
                    <!-- Google æ¨¡å‹ -->
                    <optgroup label="Google">
                      <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                      <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                      <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                      <option value="gemini-pro">Gemini Pro</option>
                    </optgroup>
                    <!-- xAI æ¨¡å‹ -->
                    <optgroup label="xAI">
                      <option value="grok-beta">Grok Beta</option>
                      <option value="grok-vision-beta">Grok Vision Beta</option>
                    </optgroup>
                    <!-- Mistral æ¨¡å‹ -->
                    <optgroup label="Mistral">
                      <option value="mistral-large-latest">Mistral Large</option>
                      <option value="mistral-medium-latest">Mistral Medium</option>
                      <option value="mistral-small-latest">Mistral Small</option>
                      <option value="codestral-latest">Codestral</option>
                    </optgroup>
                    <!-- å…¶ä»–æ¨¡å‹ -->
                    <optgroup label="å…¶ä»–">
                      <option value="command-r-plus">Cohere Command R+</option>
                      <option value="llama-3.1-405b-reasoning">Perplexity Llama 3.1 405B</option>
                      <option value="meta-llama/Llama-3.2-90B-Vision-Instruct-Turbo">Together Llama 3.2 90B</option>
                      <option value="llama-3.1-70b-versatile">Groq Llama 3.1 70B</option>
                      <option value="accounts/fireworks/models/llama-v3p1-405b-instruct">Fireworks Llama 3.1 405B</option>
                    </optgroup>
                    <!-- ä¸­æ–‡æ¨¡å‹ -->
                    <optgroup label="ä¸­æ–‡æ¨¡å‹">
                      <option value="ernie-4.0-8k">æ–‡å¿ƒä¸€è¨€ 4.0</option>
                      <option value="qwen-max">é€šä¹‰åƒé—® Max</option>
                      <option value="qwen3-235b-a22b">é€šä¹‰åƒé—® Qwen3-235B</option>
                      <option value="hunyuan-pro">è…¾è®¯æ··å…ƒ Pro</option>
                      <option value="glm-4">æ™ºè°± GLM-4</option>
                      <option value="moonshot-v1-128k">Kimi 128K</option>
                      <option value="kimi-k2-0711-preview">Kimi K2 Preview</option>
                      <option value="abab6.5-chat">MiniMax abab6.5</option>
                    </optgroup>
                    <option value="custom">ğŸ”§ è‡ªå®šä¹‰æ¨¡å‹åç§°</option>
                  </select>
                </div>
                <!-- è‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡† -->
                <div id="customModelInput" class="mt-2 hidden">
                  <input type="text" id="customModelName" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼Œå¦‚: gpt-4o-2024-08-06" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                  <p class="text-xs text-neutral-500 mt-1">è¯·è¾“å…¥å®Œæ•´çš„æ¨¡å‹åç§°ï¼Œç¡®ä¿ä¸APIæä¾›å•†çš„æ¨¡å‹åç§°ä¸€è‡´</p>
                </div>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">API å¯†é’¥</label>
              <form class="relative">
                <input type="password" id="apiKey" placeholder="sk-... (OpenAI/DeepSeek API Key)" class="w-full px-4 py-3 pr-12 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-neutral-500 hover:text-neutral-700" onclick="togglePasswordVisibility('apiKey')">
                  <i class="fa fa-eye"></i>
                </button>
              </form>
              <p class="text-xs text-neutral-500 mt-1">æ‚¨çš„APIå¯†é’¥å°†å®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-neutral-700 mb-2">API åŸºç¡€URL (å¯é€‰)</label>
              <input type="url" id="apiBaseUrl" placeholder="https://api.openai.com (OpenAI) æˆ– https://api.deepseek.com (DeepSeek)" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
              <p class="text-xs text-neutral-500 mt-1">è‡ªå®šä¹‰APIç«¯ç‚¹ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤åœ°å€</p>
            </div>
            
            <!-- æ¨¡å‹å‚æ•°é…ç½® -->
            <div class="bg-neutral-50 rounded-xl p-4">
              <h4 class="font-medium text-neutral-800 mb-3">æ¨¡å‹å‚æ•°</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-1">æ¸©åº¦ (Temperature)</label>
                  <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full">
                  <div class="flex justify-between text-xs text-neutral-500 mt-1">
                    <span>ä¿å®ˆ (0)</span>
                    <span id="temperatureValue">0.7</span>
                    <span>åˆ›æ„ (2)</span>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-1">æœ€å¤§ä»¤ç‰Œæ•°</label>
                  <input type="number" id="maxTokens" value="2048" min="1" max="8192" class="w-full px-3 py-2 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
              </div>
            </div>
            
            <!-- è¿æ¥æµ‹è¯• -->
            <div class="flex gap-3">
              <button id="testConnection" class="flex-1 py-3 border border-primary text-primary rounded-xl hover:bg-primary/5 transition-colors font-medium flex items-center justify-center gap-2">
                <i class="fa fa-plug"></i>
                æµ‹è¯•è¿æ¥
              </button>
              <button id="saveModelConfig" class="flex-1 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors font-medium flex items-center justify-center gap-2">
                <i class="fa fa-save"></i>
                ä¿å­˜é…ç½®
              </button>
            </div>
          </div>
        </div>
        
        <!-- åŠŸèƒ½è®¾ç½®æ ‡ç­¾é¡µ -->
        <div id="featuresTab" class="settings-content hidden">
          <div class="space-y-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <div class="flex items-center gap-2 text-green-800 mb-2">
                <i class="fa fa-leaf"></i>
                <span class="font-medium">åŠŸèƒ½ç®¡ç†</span>
              </div>
              <p class="text-green-700 text-sm">å¯ç”¨æˆ–ç¦ç”¨å„ç§AIåŠ©æ‰‹åŠŸèƒ½ï¼Œæ ¹æ®æ‚¨çš„éœ€æ±‚å®šåˆ¶ä½“éªŒã€‚</p>
            </div>
            
            <!-- æ ¸å¿ƒåŠŸèƒ½ -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-star text-yellow-500"></i>
                æ ¸å¿ƒåŠŸèƒ½
              </h4>
              <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">è”ç½‘æœç´¢</label>
                    <p class="text-sm text-neutral-500">å…è®¸AIè®¿é—®äº’è”ç½‘è·å–æœ€æ–°ä¿¡æ¯</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="webAccessToggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">è‡ªåŠ¨å·¥å…·è°ƒç”¨</label>
                    <p class="text-sm text-neutral-500">AIå¯ä»¥è‡ªåŠ¨é€‰æ‹©å’Œä½¿ç”¨åˆé€‚çš„å·¥å…·</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="autoToolsToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">è¯­éŸ³è¾“å…¥</label>
                    <p class="text-sm text-neutral-500">æ”¯æŒè¯­éŸ³è½¬æ–‡å­—è¾“å…¥åŠŸèƒ½</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="voiceInputToggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">Markdownæ¸²æŸ“</label>
                    <p class="text-sm text-neutral-500">ç¾åŒ–æ˜¾ç¤ºä»£ç å’Œæ ¼å¼åŒ–æ–‡æœ¬</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="markdownToggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- ç•Œé¢è®¾ç½® -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-paint-brush text-purple-500"></i>
                ç•Œé¢è®¾ç½®
              </h4>
              <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">æ·±è‰²æ¨¡å¼</label>
                    <p class="text-sm text-neutral-500">åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜ç•Œé¢</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">åŠ¨ç”»æ•ˆæœ</label>
                    <p class="text-sm text-neutral-500">å¯ç”¨ç•Œé¢åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="animationsToggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">å¿«æ·å›å¤</label>
                    <p class="text-sm text-neutral-500">æ˜¾ç¤ºå¸¸ç”¨å›å¤å»ºè®®æŒ‰é’®</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="quickRepliesToggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- å¤´åƒè®¾ç½® -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-user-circle text-indigo-500"></i>
                å¤´åƒè®¾ç½®
              </h4>
              <div class="space-y-4">
                <!-- ç”¨æˆ·å¤´åƒè®¾ç½® -->
                <div class="p-4 bg-neutral-50 rounded-lg">
                  <div class="flex items-center gap-4 mb-3">
                    <div id="userAvatarPreview" class="w-12 h-12 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-700 flex-shrink-0">
                      <i class="fa fa-user"></i>
                    </div>
                    <div class="flex-1">
                      <label class="font-medium text-neutral-700">ç”¨æˆ·å¤´åƒ</label>
                      <p class="text-sm text-neutral-500">è‡ªå®šä¹‰æ‚¨çš„ä¸ªäººå¤´åƒ</p>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-sm font-medium text-neutral-700 mb-1">å¤´åƒURL</label>
                      <input type="url" id="userAvatarUrl" placeholder="https://example.com/avatar.jpg" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm">
                    </div>
                    <div class="flex gap-2">
                      <button id="uploadUserAvatar" class="flex-1 py-2 px-3 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors text-sm font-medium flex items-center justify-center gap-2">
                        <i class="fa fa-upload"></i>
                        ä¸Šä¼ å›¾ç‰‡
                      </button>
                      <button id="resetUserAvatar" class="py-2 px-3 text-neutral-500 hover:text-neutral-700 transition-colors text-sm">
                        <i class="fa fa-refresh"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- AIæ¨¡å‹å¤´åƒè®¾ç½® -->
                <div class="p-4 bg-neutral-50 rounded-lg">
                  <div class="flex items-center gap-4 mb-3">
                    <div id="aiAvatarPreview" class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
                      <i class="fa fa-robot"></i>
                    </div>
                    <div class="flex-1">
                      <label class="font-medium text-neutral-700">AIåŠ©æ‰‹å¤´åƒ</label>
                      <p class="text-sm text-neutral-500">ä¸ºä¸åŒAIæ¨¡å‹è®¾ç½®ä¸“å±å¤´åƒ</p>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-sm font-medium text-neutral-700 mb-1">å½“å‰æ¨¡å‹</label>
                      <select id="avatarModelSelect" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm">
                        <option value="openai">ğŸ¤– OpenAI (GPTç³»åˆ—)</option>
                        <option value="anthropic">ğŸ§  Anthropic (Claude)</option>
                        <option value="deepseek">ğŸ§  DeepSeek</option>
                        <option value="google">ğŸ” Google (Gemini)</option>
                        <option value="xai">ğŸš€ xAI (Grok)</option>
                        <option value="mistral">ğŸŒŸ Mistral AI</option>
                        <option value="cohere">ğŸ’« Cohere</option>
                        <option value="perplexity">ğŸ”® Perplexity</option>
                        <option value="together">ğŸ¤ Together AI</option>
                        <option value="groq">âš¡ Groq</option>
                        <option value="fireworks">ğŸ† Fireworks AI</option>
                        <option value="baidu">ğŸ» ç™¾åº¦ (æ–‡å¿ƒä¸€è¨€)</option>
                        <option value="ali">â˜ï¸ é˜¿é‡Œ (é€šä¹‰åƒé—®)</option>
                        <option value="tencent">ğŸ§ è…¾è®¯ (æ··å…ƒ)</option>
                        <option value="zhipu">ğŸ§  æ™ºè°± (GLM)</option>
                        <option value="moonshot">ğŸŒ™ æœˆä¹‹æš—é¢ (Kimi)</option>
                        <option value="minimax">ğŸ“± MiniMax</option>
                        <option value="custom">ğŸ”§ è‡ªå®šä¹‰</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-neutral-700 mb-1">å¤´åƒURL</label>
                      <input type="url" id="aiAvatarUrl" placeholder="https://example.com/ai-avatar.jpg" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm">
                    </div>
                    <div class="flex gap-2">
                      <button id="uploadAiAvatar" class="flex-1 py-2 px-3 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors text-sm font-medium flex items-center justify-center gap-2">
                        <i class="fa fa-upload"></i>
                        ä¸Šä¼ å›¾ç‰‡
                      </button>
                      <button id="resetAiAvatar" class="py-2 px-3 text-neutral-500 hover:text-neutral-700 transition-colors text-sm">
                        <i class="fa fa-refresh"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- é¢„è®¾å¤´åƒ -->
                <div class="p-4 bg-neutral-50 rounded-lg">
                  <label class="block font-medium text-neutral-700 mb-3">é¢„è®¾å¤´åƒ</label>
                  <div class="grid grid-cols-6 gap-3">
                    <button class="preset-avatar w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white hover:scale-110 transition-transform" data-avatar="ğŸ¤–">
                      ğŸ¤–
                    </button>
                    <button class="preset-avatar w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white hover:scale-110 transition-transform" data-avatar="ğŸ§ ">
                      ğŸ§ 
                    </button>
                    <button class="preset-avatar w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white hover:scale-110 transition-transform" data-avatar="âš¡">
                      âš¡
                    </button>
                    <button class="preset-avatar w-10 h-10 rounded-full bg-red-500 flex items-center justify-center text-white hover:scale-110 transition-transform" data-avatar="ğŸ”¥">
                      ğŸ”¥
                    </button>
                    <button class="preset-avatar w-10 h-10 rounded-full bg-yellow-500 flex items-center justify-center text-white hover:scale-110 transition-transform" data-avatar="â­">
                      â­
                    </button>
                    <button class="preset-avatar w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white hover:scale-110 transition-transform" data-avatar="ğŸ’">
                      ğŸ’
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å·¥å…·ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="toolsTab" class="settings-content hidden">
          <div class="space-y-6">
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <div class="flex items-center gap-2 text-orange-800 mb-2">
                <i class="fa fa-wrench"></i>
                <span class="font-medium">å·¥å…·ç®¡ç†</span>
              </div>
              <p class="text-orange-700 text-sm">ç®¡ç†AIåŠ©æ‰‹å¯ä»¥ä½¿ç”¨çš„å·¥å…·ï¼Œæ¯ä¸ªå·¥å…·éƒ½æœ‰ç‰¹å®šçš„åŠŸèƒ½å’Œç”¨é€”ã€‚</p>
            </div>
            
            <!-- å†…ç½®å·¥å…· -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-cube text-blue-500"></i>
                å†…ç½®å·¥å…·
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 border border-neutral-200 rounded-lg hover:border-primary/30 transition-colors">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                        <i class="fa fa-calculator text-blue-600"></i>
                      </div>
                      <div>
                        <h5 class="font-medium text-neutral-800">è®¡ç®—å™¨</h5>
                        <p class="text-xs text-neutral-500">æ•°å­¦è®¡ç®—å’Œè¡¨è¾¾å¼æ±‚å€¼</p>
                      </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" class="sr-only peer" checked>
                      <div class="w-9 h-5 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  <p class="text-sm text-neutral-600">æ”¯æŒåŸºç¡€æ•°å­¦è¿ç®—ã€ç§‘å­¦è®¡ç®—å’Œå•ä½è½¬æ¢</p>
                </div>
                
                <div class="p-4 border border-neutral-200 rounded-lg hover:border-primary/30 transition-colors">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                        <i class="fa fa-code text-green-600"></i>
                      </div>
                      <div>
                        <h5 class="font-medium text-neutral-800">ä»£ç è§£é‡Šå™¨</h5>
                        <p class="text-xs text-neutral-500">ä»£ç æ‰§è¡Œå’Œè°ƒè¯•</p>
                      </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" class="sr-only peer" checked>
                      <div class="w-9 h-5 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  <p class="text-sm text-neutral-600">è¿è¡ŒPythonã€JavaScriptç­‰ä»£ç ç‰‡æ®µ</p>
                </div>
                
                <div class="p-4 border border-neutral-200 rounded-lg hover:border-primary/30 transition-colors">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                        <i class="fa fa-desktop text-purple-600"></i>
                      </div>
                      <div>
                        <h5 class="font-medium text-neutral-800">ç½‘é¡µæˆªå›¾</h5>
                        <p class="text-xs text-neutral-500">ç½‘é¡µå†…å®¹æˆªå–</p>
                      </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" class="sr-only peer" checked>
                      <div class="w-9 h-5 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  <p class="text-sm text-neutral-600">æˆªå–ç½‘é¡µå†…å®¹å¹¶è¿›è¡Œåˆ†æ</p>
                </div>
                
                <div class="p-4 border border-neutral-200 rounded-lg hover:border-primary/30 transition-colors">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                        <i class="fa fa-file-text-o text-red-600"></i>
                      </div>
                      <div>
                        <h5 class="font-medium text-neutral-800">æ–‡ä»¶å¤„ç†</h5>
                        <p class="text-xs text-neutral-500">æ–‡æ¡£è¯»å–å’Œå¤„ç†</p>
                      </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" class="sr-only peer">
                      <div class="w-9 h-5 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                  </div>
                  <p class="text-sm text-neutral-600">å¤„ç†PDFã€Wordã€Excelç­‰æ–‡ä»¶æ ¼å¼</p>
                </div>
              </div>
              
              <div class="mt-6 pt-4 border-t border-neutral-200">
                <button class="w-full py-3 text-primary border border-primary/30 rounded-xl hover:bg-primary/5 transition-colors font-medium flex items-center justify-center gap-2">
                  <i class="fa fa-plus-circle"></i>
                  æ·»åŠ è‡ªå®šä¹‰å·¥å…·
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- é«˜çº§è®¾ç½®æ ‡ç­¾é¡µ -->
        <div id="advancedTab" class="settings-content hidden">
          <div class="space-y-6">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <div class="flex items-center gap-2 text-red-800 mb-2">
                <i class="fa fa-exclamation-triangle"></i>
                <span class="font-medium">é«˜çº§è®¾ç½®</span>
              </div>
              <p class="text-red-700 text-sm">è¿™äº›è®¾ç½®å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§ï¼Œè¯·è°¨æ…ä¿®æ”¹ã€‚</p>
            </div>
            
            <!-- æ€§èƒ½è®¾ç½® -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-tachometer text-green-500"></i>
                æ€§èƒ½ä¼˜åŒ–
              </h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">è¯·æ±‚è¶…æ—¶æ—¶é—´ (ç§’)</label>
                  <input type="number" id="requestTimeout" value="30" min="5" max="300" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">æœ€å¤§é‡è¯•æ¬¡æ•°</label>
                  <input type="number" id="maxRetries" value="3" min="0" max="10" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-neutral-700 mb-2">æ¶ˆæ¯å†å²ä¿ç•™æ•°é‡</label>
                  <input type="number" id="historyLimit" value="100" min="10" max="1000" class="w-full px-4 py-3 border border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
              </div>
            </div>
            
            <!-- æ•°æ®ç®¡ç† -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-database text-blue-500"></i>
                æ•°æ®ç®¡ç†
              </h4>
              <div class="space-y-3">
                <button class="w-full py-3 text-left px-4 bg-neutral-50 hover:bg-neutral-100 rounded-xl transition-colors flex items-center justify-between">
                  <div>
                    <span class="font-medium text-neutral-800">å¯¼å‡ºèŠå¤©è®°å½•</span>
                    <p class="text-sm text-neutral-500">å°†æ‰€æœ‰å¯¹è¯å¯¼å‡ºä¸ºJSONæ–‡ä»¶</p>
                  </div>
                  <i class="fa fa-download text-neutral-500"></i>
                </button>
                
                <button class="w-full py-3 text-left px-4 bg-neutral-50 hover:bg-neutral-100 rounded-xl transition-colors flex items-center justify-between">
                  <div>
                    <span class="font-medium text-neutral-800">å¯¼å…¥èŠå¤©è®°å½•</span>
                    <p class="text-sm text-neutral-500">ä»æ–‡ä»¶æ¢å¤å¯¹è¯å†å²</p>
                  </div>
                  <i class="fa fa-upload text-neutral-500"></i>
                </button>
                
                <button class="w-full py-3 text-left px-4 bg-red-50 hover:bg-red-100 rounded-xl transition-colors flex items-center justify-between text-red-700">
                  <div>
                    <span class="font-medium">æ¸…é™¤æ‰€æœ‰æ•°æ®</span>
                    <p class="text-sm text-red-500">åˆ é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„æ•°æ®</p>
                  </div>
                  <i class="fa fa-trash text-red-500"></i>
                </button>
              </div>
            </div>
            
            <!-- å¼€å‘è€…é€‰é¡¹ -->
            <div class="bg-white border border-neutral-200 rounded-xl p-5">
              <h4 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                <i class="fa fa-code text-purple-500"></i>
                å¼€å‘è€…é€‰é¡¹
              </h4>
              <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">è°ƒè¯•æ¨¡å¼</label>
                    <p class="text-sm text-neutral-500">æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="debugMode" class="sr-only peer">
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                  <div>
                    <label class="font-medium text-neutral-700">APIæ—¥å¿—è®°å½•</label>
                    <p class="text-sm text-neutral-500">è®°å½•æ‰€æœ‰APIè¯·æ±‚å’Œå“åº”</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="apiLogging" class="sr-only peer">
                    <div class="w-11 h-6 bg-neutral-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ä¿å­˜è®¾ç½® -->
        <div class="pt-6 border-t border-neutral-200 mt-6">
          <div class="flex gap-3">
            <button id="resetSettings" class="flex-1 py-3 border border-neutral-300 text-neutral-700 rounded-xl hover:bg-neutral-50 transition-colors font-medium flex items-center justify-center gap-2">
              <i class="fa fa-refresh"></i>
              é‡ç½®è®¾ç½®
            </button>
            <button id="saveSettings" class="flex-1 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors font-medium flex items-center justify-center gap-2">
              <i class="fa fa-save"></i>
              ä¿å­˜è®¾ç½®
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å·¥å…·é€‰æ‹©é¢æ¿ (é»˜è®¤éšè—) -->
  <div id="toolsPanel" class="fixed bottom-24 right-4 md:right-6 z-40 bg-white rounded-xl shadow-lg w-64 hidden">
    <div class="p-3 border-b border-neutral-200">
      <h3 class="font-medium text-neutral-800">é€‰æ‹©å·¥å…·</h3>
    </div>
    <div class="p-2">
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-100 transition-colors flex items-center gap-2 text-neutral-700">
        <i class="fa fa-code w-5 text-center"></i>
        <span>ä»£ç è§£é‡Šå™¨</span>
      </button>
      </div>
      <div class="p-2 border-t border-neutral-200">
        <button id="closeToolsPanel" class="w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-100 transition-colors flex items-center gap-2 text-neutral-700">
          <i class="fa fa-times w-5 text-center"></i>
          <span>å–æ¶ˆ</span>
        </button>
      </div>
    </div>
  </div>

  <!-- å·¥å…·æ‰§è¡Œç»“æœé¢æ¿ (é»˜è®¤éšè—) -->
  <div id="toolResultPanel" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto shadow-xl">
      <div class="p-5 border-b border-neutral-200 flex justify-between items-center">
        <h2 class="text-xl font-bold text-neutral-800">å·¥å…·æ‰§è¡Œç»“æœ</h2>
        <button id="closeToolResult" class="p-2 rounded-full hover:bg-neutral-100">
          <i class="fa fa-times text-neutral-700"></i>
        </button>
      </div>
      
      <div id="toolResultContent" class="p-5">
        <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // DOMå…ƒç´ 
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettings = document.getElementById('closeSettings');
    const saveSettings = document.getElementById('saveSettings');
    const resetSettings = document.getElementById('resetSettings');
    const themeToggle = document.getElementById('themeToggle');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatContainer = document.getElementById('chatContainer');
    const toolsBtn = document.getElementById('toolsBtn');
    const toolsPanel = document.getElementById('toolsPanel');
    const closeToolsPanel = document.getElementById('closeToolsPanel');
    const webSearchBtn = document.getElementById('webSearchBtn');
    const toolResultPanel = document.getElementById('toolResultPanel');
    const closeToolResult = document.getElementById('closeToolResult');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const exportChatBtn = document.getElementById('exportChatBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const attachmentBtn = document.getElementById('attachmentBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    
    // æ ‡ç­¾é¡µå…ƒç´ 
    const settingsTabs = document.querySelectorAll('.settings-tab');
    const settingsContents = document.querySelectorAll('.settings-content');
    
    // çŠ¶æ€å˜é‡
    let isDarkMode = false;
    let webSearchEnabled = false;
    
    // å¯¹è¯å†å²è®°å½•
    let conversationHistory = [];
    const MAX_HISTORY_LENGTH = 20; // æœ€å¤§ä¿å­˜20è½®å¯¹è¯
    
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initEventListeners() {
      // è®¾ç½®é¢æ¿
      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          if (settingsPanel) settingsPanel.style.display = 'flex';
        });
      }
      
      if (closeSettings) {
        closeSettings.addEventListener('click', () => {
          if (settingsPanel) settingsPanel.style.display = 'none';
        });
      }
      
      if (saveSettings) {
        saveSettings.addEventListener('click', () => {
          // ä¿å­˜è®¾ç½®é€»è¾‘
          saveAllSettings();
          showNotification('è®¾ç½®å·²ä¿å­˜ï¼', 'success');
          if (settingsPanel) settingsPanel.style.display = 'none';
        });
      }
      
      if (resetSettings) {
        resetSettings.addEventListener('click', () => {
          if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            resetAllSettings();
            showNotification('è®¾ç½®å·²é‡ç½®ï¼', 'info');
          }
        });
      }
      
      // æ ‡ç­¾é¡µåˆ‡æ¢
      settingsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          switchSettingsTab(targetTab);
        });
      });
      
      // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®
      if (clearChatBtn) {
        clearChatBtn.addEventListener('click', () => {
          if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
            clearChatHistory();
            showNotification('å¯¹è¯è®°å½•å·²æ¸…ç©º', 'info');
          }
        });
      }
      
      if (exportChatBtn) {
        exportChatBtn.addEventListener('click', () => {
          exportChatHistory();
        });
      }
      
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', () => {
          toggleFullscreen();
        });
      }
      
      // åº•éƒ¨è¾“å…¥åŒºæŒ‰é’®
      if (attachmentBtn) {
        attachmentBtn.addEventListener('click', () => {
          handleAttachment();
        });
      }
      
      if (voiceBtn) {
        voiceBtn.addEventListener('click', () => {
          toggleVoiceInput();
        });
      }
      
      // AIåŠ©æ‰‹æŒ‰é’®
      const aiBtn = document.getElementById('aiBtn');
      if (aiBtn) {
        aiBtn.addEventListener('click', () => {
          showNotification('AIåŠ©æ‰‹å·²æ¿€æ´»', 'info');
          if (messageInput) {
            messageInput.focus();
          }
        });
      }
      
      // é™„ä»¶æŒ‰é’®ï¼ˆåº•éƒ¨åœ†å½¢æŒ‰é’®ï¼‰
      const attachBtn = document.getElementById('attachBtn');
      if (attachBtn) {
        attachBtn.addEventListener('click', () => {
          handleAttachment();
        });
      }
      
      // ä¸»é¢˜åˆ‡æ¢
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          isDarkMode = !isDarkMode;
          document.body.classList.toggle('bg-neutral-900', isDarkMode);
          document.body.classList.toggle('bg-neutral-100', !isDarkMode);
          document.body.classList.toggle('text-white', isDarkMode);
          document.body.classList.toggle('text-neutral-800', !isDarkMode);
          
          const moonIcon = themeToggle.querySelector('i');
          if (moonIcon) {
            if (isDarkMode) {
              moonIcon.classList.remove('fa-moon-o');
              moonIcon.classList.add('fa-sun-o');
            } else {
              moonIcon.classList.remove('fa-sun-o');
              moonIcon.classList.add('fa-moon-o');
            }
          }
        });
      }
      
      // å·¥å…·é¢æ¿
      if (toolsBtn && toolsPanel) {
        toolsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toolsPanel.style.display = toolsPanel.style.display === 'block' ? 'none' : 'block';
        });
      }
      
      if (closeToolsPanel && toolsPanel) {
        closeToolsPanel.addEventListener('click', () => {
          toolsPanel.style.display = 'none';
        });
      }
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­å·¥å…·é¢æ¿
      if (toolsPanel && toolsBtn) {
        document.addEventListener('click', (e) => {
          if (!toolsPanel.contains(e.target) && e.target !== toolsBtn) {
            toolsPanel.style.display = 'none';
          }
        });
      }
      
      // è”ç½‘æœç´¢åˆ‡æ¢
      if (webSearchBtn) {
        webSearchBtn.addEventListener('click', () => {
          webSearchEnabled = !webSearchEnabled;
          webSearchBtn.classList.toggle('bg-primary/10', webSearchEnabled);
          webSearchBtn.classList.toggle('text-primary', webSearchEnabled);
        });
      }
      
      // å…³é—­å·¥å…·ç»“æœé¢æ¿
      if (closeToolResult && toolResultPanel) {
        closeToolResult.addEventListener('click', () => {
          toolResultPanel.style.display = 'none';
        });
      }
      
      // å‘é€æ¶ˆæ¯
      if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
      }
      
      // å›è½¦å‘é€æ¶ˆæ¯
      if (messageInput) {
        messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        messageInput.addEventListener('input', () => {
          messageInput.style.height = 'auto';
          messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
        });
      }
    }
    
    // ç½‘ç»œæœç´¢åŠŸèƒ½
    async function performWebSearch(query) {
      try {
        // ä½¿ç”¨DuckDuckGo Instant Answer APIè¿›è¡Œæœç´¢
        const searchUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
        
        const response = await fetch(searchUrl, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error('æœç´¢è¯·æ±‚å¤±è´¥');
        }
        
        const data = await response.json();
        
        let searchResults = '';
        
        // å¤„ç†å³æ—¶ç­”æ¡ˆ
        if (data.Answer) {
          searchResults += `å³æ—¶ç­”æ¡ˆï¼š${data.Answer}\n\n`;
        }
        
        // å¤„ç†æ‘˜è¦ä¿¡æ¯
        if (data.Abstract) {
          searchResults += `æ‘˜è¦ï¼š${data.Abstract}\n\n`;
        }
        
        // å¤„ç†ç›¸å…³ä¸»é¢˜
        if (data.RelatedTopics && data.RelatedTopics.length > 0) {
          searchResults += 'ç›¸å…³ä¿¡æ¯ï¼š\n';
          data.RelatedTopics.slice(0, 3).forEach((topic, index) => {
            if (topic.Text) {
              searchResults += `${index + 1}. ${topic.Text}\n`;
            }
          });
        }
        
        return searchResults || 'æœªæ‰¾åˆ°ç›¸å…³æœç´¢ç»“æœ';
        
      } catch (error) {
        console.error('ç½‘ç»œæœç´¢é”™è¯¯:', error);
        // å¦‚æœDuckDuckGoä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        return await performBackupSearch(query);
      }
    }
    
    // å¤‡ç”¨æœç´¢æ–¹æ¡ˆ
    async function performBackupSearch(query) {
      try {
        // ä½¿ç”¨Wikipedia APIä½œä¸ºå¤‡ç”¨æœç´¢
        const wikiUrl = `https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
        
        const response = await fetch(wikiUrl, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.extract) {
            return `Wikipediaæ‘˜è¦ï¼š${data.extract}`;
          }
        }
        
        return 'è”ç½‘æœç´¢æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†åŸºäºå·²æœ‰çŸ¥è¯†å›ç­”æ‚¨çš„é—®é¢˜ã€‚';
        
      } catch (error) {
        console.error('å¤‡ç”¨æœç´¢é”™è¯¯:', error);
        return 'è”ç½‘æœç´¢æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†åŸºäºå·²æœ‰çŸ¥è¯†å›ç­”æ‚¨çš„é—®é¢˜ã€‚';
      }
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      if (!messageInput) return;
      
      const message = messageInput.value.trim();
      if (!message) return;
      
      // å®šä¹‰è¶…æ—¶å®šæ—¶å™¨å˜é‡
      let timeoutId;
      
      // æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è”ç½‘æœç´¢
      const webAccessEnabled = document.getElementById('webAccessToggle')?.checked || false;
      let finalMessage = message;
      
      // å¦‚æœå¼€å¯äº†è”ç½‘æœç´¢ï¼Œå…ˆè¿›è¡Œæœç´¢
      if (webAccessEnabled && webSearchEnabled) {
        // æ˜¾ç¤ºæœç´¢çŠ¶æ€
        const searchingId = 'searching-' + Date.now();
        addLoadingMessage(searchingId);
        
        try {
          const searchResults = await performWebSearch(message);
          removeLoadingMessage(searchingId);
          
          // å°†æœç´¢ç»“æœæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
          finalMessage = `ç”¨æˆ·é—®é¢˜ï¼š${message}\n\næœ€æ–°ç½‘ç»œä¿¡æ¯ï¼š\n${searchResults}\n\nè¯·åŸºäºä»¥ä¸Šæœ€æ–°ä¿¡æ¯å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`;
          
        } catch (error) {
          removeLoadingMessage(searchingId);
          console.error('æœç´¢å¤±è´¥:', error);
        }
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²ï¼ˆä½¿ç”¨åŸå§‹æ¶ˆæ¯ï¼‰
      addToConversationHistory('user', message);
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯ï¼ˆæ˜¾ç¤ºåŸå§‹æ¶ˆæ¯ï¼‰
      const userMessageId = 'user-message-' + Date.now();
      addMessageToChat(message, 'user', userMessageId);
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      messageInput.value = '';
      messageInput.style.height = '50px';
      
      // æ·»åŠ åŠ è½½çŠ¶æ€æ¶ˆæ¯
      try {
        // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
        const aiMessageId = 'ai-message-' + Date.now();
        addStreamingMessage(aiMessageId);
        
        // ç”ŸæˆAIå›å¤ï¼ˆæµå¼ï¼‰ï¼Œä½¿ç”¨åŒ…å«æœç´¢ç»“æœçš„æ¶ˆæ¯
        await generateAIResponseStreaming(finalMessage, aiMessageId);
      } catch (error) {
        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        const errorMsg = 'æŠ±æ­‰ï¼Œç”Ÿæˆå›å¤æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
        const errorMessageId = 'ai-error-' + Date.now();
        addMessageToChat(errorMsg, 'ai', errorMessageId);
        addToConversationHistory('assistant', errorMsg);
        console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
      } finally {
        // é‡ç½®è”ç½‘æœç´¢çŠ¶æ€
        if (webSearchEnabled) {
          webSearchEnabled = false;
          webSearchBtn.classList.remove('bg-primary/10', 'text-primary');
        }
      }
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯å†å²
    function addToConversationHistory(role, content) {
      // æ·»åŠ æ–°æ¶ˆæ¯åˆ°å†å²è®°å½•
      conversationHistory.push({
        role: role,
        content: content
      });
      
      // å¦‚æœå†å²è®°å½•è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œåˆ é™¤æœ€æ—©çš„å¯¹è¯ï¼ˆä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ï¼‰
      if (conversationHistory.length > MAX_HISTORY_LENGTH) {
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç³»ç»Ÿæ¶ˆæ¯çš„ç´¢å¼•
        let firstNonSystemIndex = conversationHistory.findIndex(msg => msg.role !== 'system');
        if (firstNonSystemIndex === -1) firstNonSystemIndex = 0;
        
        // åˆ é™¤æœ€æ—©çš„ç”¨æˆ·-åŠ©æ‰‹å¯¹è¯
        conversationHistory.splice(firstNonSystemIndex, 2);
      }
    }
    
    // è·å–å®Œæ•´çš„å¯¹è¯å†å²ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºï¼‰
    function getFullConversationHistory() {
      const systemMessage = {
        role: 'system',
        content: 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›ç­”é—®é¢˜ã€‚'
      };
      
      return [systemMessage, ...conversationHistory];
    }
    
    // Markdownæ¸²æŸ“å‡½æ•°
    function renderMarkdown(text) {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const markdownEnabled = settings.markdownRender !== false; // é»˜è®¤å¯ç”¨
      
      if (!markdownEnabled || typeof marked === 'undefined') {
        return text.replace(/\n/g, '<br>');
      }
      
      try {
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
          breaks: true,          // æ”¯æŒæ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
          gfm: true,            // å¯ç”¨GitHubé£æ ¼Markdown
          sanitize: false,      // ä¸æ¸…ç†HTMLï¼ˆç”±DOMPurifyå¤„ç†ï¼‰
          smartLists: true,     // æ™ºèƒ½åˆ—è¡¨å¤„ç†
          smartypants: true,    // æ™ºèƒ½æ ‡ç‚¹ç¬¦å·è½¬æ¢
          xhtml: false,         // ä¸ä½¿ç”¨XHTMLæ ¼å¼
          headerIds: false,     // ä¸ç”Ÿæˆæ ‡é¢˜ID
          mangle: false,        // ä¸æ··æ·†é‚®ç®±åœ°å€
          pedantic: false,      // ä¸ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼
          silent: false         // ä¸é™é»˜é”™è¯¯
        });
        
        // è‡ªå®šä¹‰æ¸²æŸ“å™¨ä»¥å¤„ç†ç‰¹æ®Šç¬¦å·
        const renderer = new marked.Renderer();
        
        // å¤„ç†ä»£ç å—
        renderer.code = function(code, language) {
          const validLang = language && language.match(/^[a-zA-Z0-9_+-]*$/) ? language : '';
          const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
          const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `<div class="code-block-container relative">
            <div class="code-block-header flex justify-between items-center bg-gray-100 px-3 py-2 text-sm text-gray-600 border-b">
              <span class="code-language">${validLang || 'text'}</span>
              <button class="copy-code-btn flex items-center gap-1 px-2 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded transition-colors" onclick="copyCodeBlock('${codeId}')" title="å¤åˆ¶ä»£ç ">
                <i class="fa fa-copy"></i>
                <span>å¤åˆ¶</span>
              </button>
            </div>
            <pre><code id="${codeId}" class="language-${validLang}" data-raw-code="${code.replace(/"/g, '&quot;')}">${escapedCode}</code></pre>
          </div>`;
        };
        
        // å¤„ç†è¡Œå†…ä»£ç 
        renderer.codespan = function(code) {
          return `<code>${code}</code>`;
        };
        
        // å¤„ç†é“¾æ¥
        renderer.link = function(href, title, text) {
          const titleAttr = title ? ` title="${title}"` : '';
          return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
        };
        
        // å¤„ç†è¡¨æ ¼
        renderer.table = function(header, body) {
          return `<table class="markdown-table">
<thead>
${header}</thead>
<tbody>
${body}</tbody>
</table>`;
        };
        
        // å¤„ç†åˆ é™¤çº¿
        renderer.del = function(text) {
          return `<del>${text}</del>`;
        };
        
        // å¤„ç†å¼ºè°ƒæ–‡æœ¬
        renderer.strong = function(text) {
          return `<strong>${text}</strong>`;
        };
        
        renderer.em = function(text) {
          return `<em>${text}</em>`;
        };
        
        marked.setOptions({ renderer });
        
        let html = marked.parse(text);
        
        // ä½¿ç”¨DOMPurifyæ¸…ç†HTMLï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (typeof DOMPurify !== 'undefined') {
          html = DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'b', 'em', 'i', 'u', 's', 'del', 'strike', 
                          'code', 'pre', 'blockquote', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                          'ul', 'ol', 'li', 'a', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 
                          'hr', 'img', 'div', 'span', 'mark', 'kbd', 'sub', 'sup', 'button'],
            ALLOWED_ATTR: ['href', 'title', 'target', 'rel', 'src', 'alt', 'class', 'id', 'style', 'onclick'],
            KEEP_CONTENT: true,
            ALLOW_DATA_ATTR: false
          });
        }
        
        return html;
      } catch (error) {
        console.error('Markdownæ¸²æŸ“é”™è¯¯:', error);
        return text.replace(/\n/g, '<br>');
      }
    }
    


    // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯
    function addMessageToChat(message, sender, messageId = null) {
      if (!chatContainer) return;
      
      // å¦‚æœæ²¡æœ‰æä¾›messageIdï¼Œç”Ÿæˆä¸€ä¸ª
      if (!messageId) {
        messageId = sender + '-message-' + Date.now();
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex items-start gap-3 animate-fade-in`;
      messageDiv.id = messageId;
      
      let avatar, bgColor;
      
      if (sender === 'user') {
        avatar = getUserAvatar();
        bgColor = 'bg-primary text-white';
        messageDiv.classList.add('justify-end');
      } else {
        avatar = getAIAvatar();
        bgColor = 'bg-white';
      }
      
      // æ¸²æŸ“æ¶ˆæ¯å†…å®¹
      const renderedMessage = sender === 'ai' ? renderMarkdown(message) : message.replace(/\n/g, '<br>');
      const contentClass = sender === 'ai' ? 'markdown-content' : '';
      
      messageDiv.innerHTML = `
        ${sender === 'ai' ? avatar : ''}
        <div class="flex flex-col">
          <div class="${bgColor} rounded-2xl px-4 py-3 shadow-sm ${sender === 'user' ? 'min-w-[120px]' : 'max-w-[85%]'}" ${sender === 'ai' ? 'style="max-width: min(85%, 800px);"' : ''}>
            <div class="${sender === 'user' ? 'text-white' : 'text-neutral-800'} ${contentClass} message-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}">${renderedMessage}</div>
            ${sender === 'ai' && webSearchEnabled ? `
              <div class="mt-3 pt-3 border-t border-neutral-100 flex items-center gap-2 text-xs text-neutral-500">
                <i class="fa fa-search"></i>
                <span>æ­¤å›å¤åŸºäºæœ€æ–°ç½‘ç»œä¿¡æ¯</span>
              </div>
            ` : ''}
          </div>
          ${sender === 'ai' ? `
            <div class="flex items-center gap-2 mt-2 ml-2">
              <button class="action-btn p-1.5 rounded-full hover:bg-neutral-100 transition-colors text-neutral-500 hover:text-neutral-700" title="é‡æ–°ç”Ÿæˆ" onclick="regenerateMessage('${messageId}')">
                <i class="fa fa-refresh text-xs"></i>
              </button>
              <button class="action-btn p-1.5 rounded-full hover:bg-neutral-100 transition-colors text-neutral-500 hover:text-neutral-700" title="å¤åˆ¶" onclick="copyMessage('${messageId}')">
                <i class="fa fa-copy text-xs"></i>
              </button>
              <button class="action-btn p-1.5 rounded-full hover:bg-neutral-100 transition-colors text-neutral-500 hover:text-neutral-700" title="æ”¶è—" onclick="favoriteMessage('${messageId}')">
                <i class="fa fa-heart-o text-xs"></i>
              </button>
            </div>
          ` : ''}
        </div>
        ${sender === 'user' ? avatar : ''}
      `;
      
      chatContainer.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    }
    
    // æ·»åŠ æµå¼æ¶ˆæ¯å®¹å™¨
    function addStreamingMessage(messageId) {
      if (!chatContainer) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.className = 'flex items-start gap-3 animate-fade-in';
      
      messageDiv.innerHTML = `
        ${getAIAvatar()}
        <div class="flex flex-col">
          <div class="bg-white rounded-2xl px-4 py-3 shadow-sm max-w-[85%] min-w-[120px]" style="max-width: min(85%, 800px);">
            <p class="text-neutral-800 message-bubble ai-message" id="${messageId}-content">
              <span class="typing-cursor"></span>
            </p>
          </div>
        </div>
      `;
      
      chatContainer.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    }
    
    // å­—ç¬¦çº§åˆ«çš„å¹³æ»‘æ¸²æŸ“æ•ˆæœ
    let renderQueue = new Map(); // å­˜å‚¨æ¯ä¸ªæ¶ˆæ¯çš„æ¸²æŸ“é˜Ÿåˆ—
    
    function smoothRenderText(messageId, targetText, currentText = '', speed = 30) {
      const contentElement = document.getElementById(`${messageId}-content`);
      if (!contentElement) return;
      
      // å¦‚æœç›®æ ‡æ–‡æœ¬æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
      if (targetText === currentText) {
        return;
      }
      
      // æ¸…é™¤ä¹‹å‰çš„æ¸²æŸ“é˜Ÿåˆ—
      if (renderQueue.has(messageId)) {
        clearTimeout(renderQueue.get(messageId));
      }
      
      // è®¡ç®—éœ€è¦æ·»åŠ çš„å­—ç¬¦
      const nextLength = Math.min(currentText.length + Math.ceil(Math.random() * 3) + 1, targetText.length);
      const newText = targetText.substring(0, nextLength);
      
      // æ¸²æŸ“å½“å‰æ–‡æœ¬
      const renderedContent = renderMarkdown(content);
                contentElement.innerHTML = renderedContent + '<span class="typing-cursor">âš¡</span>';
      contentElement.className = 'text-neutral-800 markdown-content';
      
      // å¦‚æœè¿˜æœ‰æ›´å¤šå†…å®¹éœ€è¦æ¸²æŸ“
      if (newText.length < targetText.length) {
        const timeoutId = setTimeout(() => {
          smoothRenderText(messageId, targetText, newText, speed);
        }, speed + Math.random() * 20); // æ·»åŠ éšæœºå»¶è¿Ÿæ¨¡æ‹ŸçœŸå®æ‰“å­—
        
        renderQueue.set(messageId, timeoutId);
      } else {
        // æ¸²æŸ“å®Œæˆï¼Œç§»é™¤å…‰æ ‡
        contentElement.innerHTML = renderedContent;
        renderQueue.delete(messageId);
      }
    }
    
    // è·å–å½“å‰æ¨¡å‹çš„æ¸²æŸ“é…ç½®
    function getModelRenderConfig() {
      const modelVersion = document.getElementById('modelVersion')?.value || '';
      const modelProvider = document.getElementById('modelSelect')?.value || 'openai';
      
      // æ ¹æ®æ¨¡å‹ç±»å‹è¿”å›ä¸åŒçš„æ¸²æŸ“é…ç½®
      if (modelVersion.includes('kimi') || modelProvider === 'moonshot') {
        return { updateThreshold: 1, reasoningThreshold: 5, scrollDelay: 3 }; // Kimiæ¨¡å‹ä¼˜åŒ–ï¼šæ›´é¢‘ç¹æ›´æ–°ï¼Œå‡å°‘å¡é¡¿
      } else if (modelVersion.includes('qwen3') || modelVersion.includes('qwen') || modelProvider === 'ali') {
        return { updateThreshold: 6, reasoningThreshold: 12, scrollDelay: 10 }; // Qwenæ¨¡å‹
      } else if (modelVersion.includes('deepseek') || modelVersion.includes('reasoner')) {
        return { updateThreshold: 8, reasoningThreshold: 15, scrollDelay: 12 }; // DeepSeekæ¨ç†æ¨¡å‹
      } else if (modelVersion.includes('claude') || modelProvider === 'anthropic') {
        return { updateThreshold: 6, reasoningThreshold: 12, scrollDelay: 10 }; // Claudeæ¨¡å‹
      } else {
        return { updateThreshold: 10, reasoningThreshold: 20, scrollDelay: 16 }; // é»˜è®¤é…ç½®
      }
    }
    
    // æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
    function updateStreamingMessage(messageId, content, isComplete = false, isWebSearchResult = false, reasoningContent = '', isReasonerModel = false) {
      const contentElement = document.getElementById(`${messageId}-content`);
      if (contentElement) {
        // è·å–å½“å‰æ¨¡å‹çš„æ¸²æŸ“é…ç½®
        const renderConfig = getModelRenderConfig();
        
        // ç¼“å­˜ä¸Šæ¬¡çš„å†…å®¹ï¼Œé¿å…ä¸å¿…è¦çš„DOMæ›´æ–°
        const lastContent = contentElement.getAttribute('data-last-content') || '';
        const currentContent = content + (reasoningContent || '');
        
        // å¦‚æœå†…å®¹æ²¡æœ‰å˜åŒ–ä¸”ä¸æ˜¯å®ŒæˆçŠ¶æ€ï¼Œè·³è¿‡æ›´æ–°
        if (!isComplete && lastContent === currentContent) {
          return;
        }
        
        // æ›´æ–°ç¼“å­˜çš„å†…å®¹
        contentElement.setAttribute('data-last-content', currentContent);
        
        // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ï¼Œå¹¶æ·»åŠ èŠ‚æµ
        if (contentElement._updatePending) return;
        contentElement._updatePending = true;
        
        requestAnimationFrame(() => {
          contentElement._updatePending = false;
        
        if (isComplete) {
          const messageDivComplete = document.getElementById(messageId);
          if (messageDivComplete) {
            // å¤„ç†æ¨ç†å†…å®¹å®¹å™¨
             let reasoningContainer = messageDivComplete.querySelector('.reasoning-container');
            if (isReasonerModel && reasoningContent) {
              if (!reasoningContainer) {
                reasoningContainer = document.createElement('div');
                reasoningContainer.className = 'reasoning-container mb-3';
                reasoningContainer.innerHTML = `
                <div class="reasoning-section bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                  <div class="flex items-center justify-between mb-2 text-blue-800">
                    <div class="flex items-center gap-2">
                      <i class="fa fa-lightbulb-o"></i>
                      <span class="font-medium">AI æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <button class="reasoning-toggle-btn p-1 rounded hover:bg-blue-100 transition-colors" onclick="toggleReasoning(this)">
                      <i class="fa fa-chevron-up text-xs"></i>
                    </button>
                  </div>
                  <div class="reasoning-content text-blue-700 text-sm whitespace-pre-wrap"></div>
                </div>
              `;
                contentElement.parentNode.insertBefore(reasoningContainer, contentElement);
              }
              // æ›´æ–°æ¨ç†å†…å®¹å¹¶æ¸²æŸ“Markdown
              const reasoningContentDiv = reasoningContainer.querySelector('.reasoning-content');
              if (reasoningContentDiv) {
                reasoningContentDiv.innerHTML = renderMarkdown(reasoningContent);
                
                // æ¨ç†è¿‡ç¨‹å®Œæˆåè‡ªåŠ¨æ”¶èµ·
                setTimeout(() => {
                  const toggleBtn = reasoningContainer.querySelector('.reasoning-toggle-btn');
                  if (toggleBtn) {
                    const toggleIcon = toggleBtn.querySelector('i');
                    reasoningContentDiv.style.display = 'none';
                    toggleIcon.className = 'fa fa-chevron-down text-xs';
                    reasoningContainer.querySelector('.reasoning-section').style.maxHeight = '60px';
                  }
                }, 500); // å»¶è¿Ÿ500msåè‡ªåŠ¨æ”¶èµ·
              }
            }
          }
          
          // å®Œæˆæ—¶æ¸²æŸ“æ­£å¼å›ç­”çš„Markdownï¼Œç¡®ä¿ç§»é™¤æ‰“å­—æœºå…‰æ ‡
          if (renderQueue.has(messageId)) {
            clearTimeout(renderQueue.get(messageId));
            renderQueue.delete(messageId);
          }
          
          // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å…‰æ ‡å…ƒç´ 
          const existingCursors = contentElement.querySelectorAll('.typing-cursor');
          existingCursors.forEach(cursor => cursor.remove());
          
          // ä½¿ç”¨DocumentFragmentå‡å°‘DOMé‡æ’
          const fragment = document.createDocumentFragment();
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = renderMarkdown(content);
          
          // æ‰¹é‡æ›´æ–°DOM
          contentElement.innerHTML = '';
          while (tempDiv.firstChild) {
            fragment.appendChild(tempDiv.firstChild);
          }
          contentElement.appendChild(fragment);
          contentElement.className = 'text-neutral-800 markdown-content';
          contentElement.setAttribute('data-displayed-text', content);
          
          // å†æ¬¡ç¡®ä¿æ²¡æœ‰å…‰æ ‡æ®‹ç•™
          setTimeout(() => {
            const remainingCursors = contentElement.querySelectorAll('.typing-cursor');
            remainingCursors.forEach(cursor => cursor.remove());
          }, 100);
          
          // å°†AIå›å¤æ·»åŠ åˆ°å¯¹è¯å†å²
          addToConversationHistory('assistant', content);
          
          // æ·»åŠ æŒ‰é’®åˆ°æ¶ˆæ¯å®¹å™¨
          const messageDiv = document.getElementById(messageId);
          if (messageDiv) {
            // æŸ¥æ‰¾flexå®¹å™¨ï¼ˆæ¶ˆæ¯æ°”æ³¡çš„çˆ¶å®¹å™¨ï¼‰
            const flexContainer = messageDiv.querySelector('.flex.flex-col');
            if (flexContainer) {
              // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç½‘ç»œæœç´¢æ ‡è¯†
              const existingWebIndicator = flexContainer.querySelector('.web-search-indicator');
              if (!existingWebIndicator && isWebSearchResult) {
                // æ·»åŠ ç½‘ç»œæœç´¢æ ‡è¯†
                const webIndicatorDiv = document.createElement('div');
                webIndicatorDiv.className = 'mt-3 pt-3 border-t border-neutral-100 flex items-center gap-2 text-xs text-neutral-500 web-search-indicator';
                webIndicatorDiv.innerHTML = `
                  <i class="fa fa-search"></i>
                  <span>æ­¤å›å¤åŸºäºæœ€æ–°ç½‘ç»œä¿¡æ¯</span>
                `;
                
                // å°†ç½‘ç»œæœç´¢æ ‡è¯†æ·»åŠ åˆ°æ¶ˆæ¯æ°”æ³¡ä¸­
                const messageBubble = flexContainer.querySelector('.bg-white.rounded-2xl');
                if (messageBubble) {
                  messageBubble.appendChild(webIndicatorDiv);
                }
              }
              
              // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æŒ‰é’®å®¹å™¨
              const existingButtons = flexContainer.querySelector('.action-buttons');
              if (!existingButtons) {
                // åˆ›å»ºæŒ‰é’®å®¹å™¨
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex items-center gap-2 mt-2 ml-2 action-buttons';
                buttonsDiv.innerHTML = `
                  <button class="action-btn p-1.5 rounded-full hover:bg-neutral-100 transition-colors text-neutral-500 hover:text-neutral-700" title="é‡æ–°ç”Ÿæˆ" onclick="regenerateMessage('${messageId}')">
                    <i class="fa fa-refresh text-xs"></i>
                  </button>
                  <button class="action-btn p-1.5 rounded-full hover:bg-neutral-100 transition-colors text-neutral-500 hover:text-neutral-700" title="å¤åˆ¶" onclick="copyMessage('${messageId}')">
                    <i class="fa fa-copy text-xs"></i>
                  </button>
                  <button class="action-btn p-1.5 rounded-full hover:bg-neutral-100 transition-colors text-neutral-500 hover:text-neutral-700" title="æ”¶è—" onclick="favoriteMessage('${messageId}')">
                    <i class="fa fa-heart-o text-xs"></i>
                  </button>
                `;
                
                // å°†æŒ‰é’®å®¹å™¨æ·»åŠ åˆ°flexå®¹å™¨ä¸­
                flexContainer.appendChild(buttonsDiv);
              }
            }
          }
        } else {
          // æµå¼è¾“å‡ºæ—¶åˆ†åˆ«å¤„ç†æ¨ç†å†…å®¹å’Œæ­£å¼å›ç­”
          const messageDiv = document.getElementById(messageId);
          if (messageDiv) {
            // æŸ¥æ‰¾æˆ–åˆ›å»ºæ¨ç†å†…å®¹å®¹å™¨
            let reasoningContainer = messageDiv.querySelector('.reasoning-container');
            if (isReasonerModel && reasoningContent && !reasoningContainer) {
              reasoningContainer = document.createElement('div');
              reasoningContainer.className = 'reasoning-container mb-3';
              reasoningContainer.innerHTML = `
                <div class="reasoning-section bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                  <div class="flex items-center justify-between mb-2 text-blue-800">
                    <div class="flex items-center gap-2">
                      <i class="fa fa-lightbulb-o"></i>
                      <span class="font-medium">AI æ€è€ƒè¿‡ç¨‹</span>
                    </div>
                    <button class="reasoning-toggle-btn p-1 rounded hover:bg-blue-100 transition-colors" onclick="toggleReasoning(this)">
                      <i class="fa fa-chevron-up text-xs"></i>
                    </button>
                  </div>
                  <div class="reasoning-content text-blue-700 text-sm whitespace-pre-wrap"></div>
                </div>
              `;
              // å°†æ¨ç†å®¹å™¨æ’å…¥åˆ°å†…å®¹å®¹å™¨ä¹‹å‰
              contentElement.parentNode.insertBefore(reasoningContainer, contentElement);
            }
            
            // ä¼˜åŒ–æ¨ç†å†…å®¹æ›´æ–°ï¼Œå‡å°‘é¢‘ç¹æ“ä½œ
             if (isReasonerModel && reasoningContent && reasoningContainer) {
               const reasoningContentDiv = reasoningContainer.querySelector('.reasoning-content');
               if (reasoningContentDiv) {
                 const lastReasoningContent = reasoningContentDiv.getAttribute('data-last-reasoning') || '';
                 const lengthDiff = Math.abs(reasoningContent.length - lastReasoningContent.length);
                 // æ ¹æ®æ¨¡å‹ç±»å‹è°ƒæ•´æ¨ç†å†…å®¹æ›´æ–°é˜ˆå€¼
                  if (lengthDiff > renderConfig.reasoningThreshold || lastReasoningContent === '') {
                   reasoningContentDiv.textContent = reasoningContent;
                   reasoningContentDiv.setAttribute('data-last-reasoning', reasoningContent);
                 }
               }
             }
            
            // ä¼˜åŒ–æµå¼æ¸²æŸ“ï¼Œå‡å°‘é‡å¤çš„Markdownè§£æ
            const currentDisplayedText = contentElement.getAttribute('data-displayed-text') || '';
            if (content !== currentDisplayedText) {
              contentElement.setAttribute('data-displayed-text', content);
              
              // æ™ºèƒ½æ¸²æŸ“ï¼šæ ¹æ®æ¨¡å‹ç±»å‹è°ƒæ•´æ¸²æŸ“é˜ˆå€¼
              const lengthDiff = Math.abs(content.length - currentDisplayedText.length);
              const modelVersion = document.getElementById('modelVersion')?.value || '';
              const modelProvider = document.getElementById('modelSelect')?.value || 'openai';
              const isKimiModel = modelVersion.includes('kimi') || modelProvider === 'moonshot';
              
              // Kimiæ¨¡å‹ä½¿ç”¨æ›´æ¿€è¿›çš„å®æ—¶æ¸²æŸ“ç­–ç•¥
              if (isKimiModel || lengthDiff > renderConfig.updateThreshold || content.includes('```') || content.includes('**') || content.includes('*')) {
                // Kimiæ¨¡å‹æˆ–åŒ…å«æ ¼å¼åŒ–å†…å®¹æ—¶è¿›è¡Œå®Œæ•´æ¸²æŸ“
                const renderedContent = renderMarkdown(content);
                contentElement.innerHTML = renderedContent + '<span class="typing-cursor">âš¡</span>';
              } else {
                // å…¶ä»–æ¨¡å‹ä½¿ç”¨ç®€å•æ–‡æœ¬è¿½åŠ ï¼Œé¿å…é‡å¤æ¸²æŸ“
                const textNode = document.createTextNode(content.slice(currentDisplayedText.length));
                const cursor = contentElement.querySelector('.typing-cursor');
                if (cursor) {
                  contentElement.insertBefore(textNode, cursor);
                } else {
                  contentElement.appendChild(textNode);
                  contentElement.innerHTML += '<span class="typing-cursor">âš¡</span>';
                }
              }
              contentElement.className = 'text-neutral-800 markdown-content';
            }
          }
        }
        
        }); // ç»“æŸ requestAnimationFrame
        
        // æ ¹æ®æ¨¡å‹ç±»å‹ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
        clearTimeout(window.scrollTimeout);
        window.scrollTimeout = setTimeout(() => {
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth'
          });
        }, renderConfig.scrollDelay); // ä½¿ç”¨è‡ªé€‚åº”æ»šåŠ¨å»¶è¿Ÿ
      }
    }
    
    // æ·»åŠ åŠ è½½æ¶ˆæ¯
    function addLoadingMessage(messageId) {
      if (!chatContainer) return;
      
      const loadingDiv = document.createElement('div');
      loadingDiv.id = messageId;
      loadingDiv.className = 'flex items-start gap-3 animate-fade-in';
      
      loadingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
          <i class="fa fa-robot"></i>
        </div>
        <div class="bg-white rounded-2xl px-4 py-3 shadow-sm max-w-[85%] min-w-[120px]" style="max-width: min(85%, 800px);">
          <div class="flex items-center gap-2 text-neutral-600">
            <div class="flex gap-1">
              <div class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
              <div class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
              <div class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            </div>
            <span class="text-sm">AIæ­£åœ¨æ€è€ƒ...</span>
          </div>
        </div>
      `;
      
      chatContainer.appendChild(loadingDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    }
    
    // ç§»é™¤åŠ è½½æ¶ˆæ¯
    function removeLoadingMessage(messageId) {
      const loadingMessage = document.getElementById(messageId);
      if (loadingMessage) {
        loadingMessage.remove();
      }
    }
    
    // ç”ŸæˆAIå›å¤ï¼ˆæµå¼ï¼‰
    async function generateAIResponseStreaming(userMessage, messageId) {
      // è·å–ç”¨æˆ·è®¾ç½®
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const apiKey = settings.apiKey || document.getElementById('apiKey')?.value;
      let baseUrl = settings.baseUrl || document.getElementById('apiBaseUrl')?.value;
      const modelProvider = settings.model || document.getElementById('modelSelect')?.value || 'openai';
      const modelVersion = settings.modelVersion || getActualModelVersion();
      const temperature = parseFloat(settings.temperature || document.getElementById('temperature')?.value || 0.7);
      const maxTokens = parseInt(settings.maxTokens || document.getElementById('maxTokens')?.value || 2048);
      const requestTimeout = parseInt(settings.requestTimeout || document.getElementById('requestTimeout')?.value || 180) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’ï¼ŒKimiæ¨¡å‹ä½¿ç”¨180ç§’è¶…æ—¶
      
      // æ ¹æ®æ¨¡å‹æä¾›å•†è®¾ç½®é»˜è®¤çš„baseUrl
      if (!baseUrl) {
        switch(modelProvider) {
          case 'deepseek':
            baseUrl = 'https://api.deepseek.com';
            break;
          case 'openai':
            baseUrl = 'https://api.openai.com';
            break;
          case 'anthropic':
            baseUrl = 'https://api.anthropic.com';
            break;
          case 'google':
            baseUrl = 'https://generativelanguage.googleapis.com';
            break;
          case 'xai':
            baseUrl = 'https://api.x.ai';
            break;
          case 'mistral':
            baseUrl = 'https://api.mistral.ai';
            break;
          case 'cohere':
            baseUrl = 'https://api.cohere.ai';
            break;
          case 'perplexity':
            baseUrl = 'https://api.perplexity.ai';
            break;
          case 'together':
            baseUrl = 'https://api.together.xyz';
            break;
          case 'groq':
            baseUrl = 'https://api.groq.com';
            break;
          case 'fireworks':
            baseUrl = 'https://api.fireworks.ai';
            break;
          case 'baidu':
            baseUrl = 'https://aip.baidubce.com';
            break;
          case 'ali':
            baseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
            break;
          case 'tencent':
            baseUrl = 'https://hunyuan.tencentcloudapi.com';
            break;
          case 'zhipu':
            baseUrl = 'https://open.bigmodel.cn';
            break;
          case 'moonshot':
            baseUrl = 'https://api.moonshot.cn';
            break;
          case 'minimax':
            baseUrl = 'https://api.minimax.chat';
            break;
          default:
            baseUrl = 'https://api.openai.com';
        }
      }
      
      // å¦‚æœæ²¡æœ‰é…ç½®APIå¯†é’¥ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
      if (!apiKey) {
        updateStreamingMessage(messageId, 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥ï¼Œç„¶åé‡æ–°å‘é€æ¶ˆæ¯ã€‚', true);
        return;
      }
      
      try {
        // æ ¹æ®ä¸åŒæä¾›å•†æ„å»ºä¸åŒçš„endpoint
        let endpoint;
        if (modelProvider === 'deepseek') {
          endpoint = baseUrl.endsWith('/') ? baseUrl + 'chat/completions' : baseUrl + '/chat/completions';
        } else {
          endpoint = baseUrl.endsWith('/') ? baseUrl + 'v1/chat/completions' : baseUrl + '/v1/chat/completions';
        }
        
        // æ„å»ºæ¶ˆæ¯æ•°ç»„
        let messages;
        if (userMessage.includes('æœ€æ–°ç½‘ç»œä¿¡æ¯ï¼š')) {
          // å¦‚æœåŒ…å«æœç´¢ç»“æœï¼Œä½¿ç”¨ç‰¹æ®Šçš„æ¶ˆæ¯ç»“æ„
          const systemMessage = {
            role: 'system',
            content: 'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›ç­”é—®é¢˜ã€‚å½“ç”¨æˆ·æä¾›äº†æœ€æ–°ç½‘ç»œä¿¡æ¯æ—¶ï¼Œè¯·ä¼˜å…ˆåŸºäºè¿™äº›ä¿¡æ¯æ¥å›ç­”é—®é¢˜ï¼Œå¹¶åœ¨å›ç­”ä¸­æ˜ç¡®è¡¨æ˜è¿™æ˜¯åŸºäºæœ€æ–°ä¿¡æ¯çš„å›å¤ã€‚'
          };
          messages = [systemMessage, { role: 'user', content: userMessage }];
        } else {
          // æ­£å¸¸æƒ…å†µä¸‹ä½¿ç”¨å®Œæ•´å¯¹è¯å†å²
          messages = getFullConversationHistory();
        }
        
        // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶æ§åˆ¶
        const abortController = new AbortController();
        const timeoutId = setTimeout(() => {
          abortController.abort();
        }, requestTimeout);
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          },
          body: JSON.stringify({
            model: modelVersion,
            messages: messages,
            temperature: temperature,
            max_tokens: maxTokens,
            stream: true,
            // Qwen3æ¨¡å‹ç‰¹æ®Šå‚æ•°æ”¯æŒ
            ...(modelVersion.includes('qwen3') && modelProvider === 'ali' ? {
              extra_body: { enable_thinking: false }
            } : {})
          }),
          // æ·»åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†é…ç½®
          signal: abortController.signal,
          mode: 'cors',
          credentials: 'omit'
        });
        
        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        // å¤„ç†æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let reasoningContent = '';
        const isWebSearchResult = userMessage.includes('æœ€æ–°ç½‘ç»œä¿¡æ¯ï¼š');
        const isReasonerModel = modelVersion.includes('reasoner');
        
        // Kimiæ¨¡å‹ä¸“ç”¨ï¼šé€å­—è¾“å‡ºç¼“å†²æœºåˆ¶
        let characterBuffer = '';
        let lastUpdateTime = 0;
        const isKimiModel = modelVersion.includes('kimi') || modelProvider === 'moonshot';
        // Kimiæ¨¡å‹ä½¿ç”¨é€å­—è¾“å‡ºï¼Œå…¶ä»–æ¨¡å‹ä¿æŒåŸæœ‰èŠ‚æµ
        const updateThrottle = isKimiModel ? 100 : 50; // Kimiæ¨¡å‹ä½¿ç”¨100msé—´éš”è¿›è¡Œé€å­—è¾“å‡º
        
        // Kimiæ¨¡å‹ä¸“ç”¨ï¼šæ·»åŠ è¿æ¥ç›‘æ§
        let lastDataTime = Date.now();
        const kimiTimeout = isKimiModel ? 10000 : 30000; // Kimiæ¨¡å‹ä½¿ç”¨æ›´çŸ­çš„è¶…æ—¶æ—¶é—´
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          // æ›´æ–°æœ€åæ¥æ”¶æ•°æ®çš„æ—¶é—´
          lastDataTime = Date.now();
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') {
                updateStreamingMessage(messageId, fullResponse, true, isWebSearchResult, reasoningContent, isReasonerModel);
                return;
              }
              
              try {
                const parsed = JSON.parse(data);
                if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta) {
                  let shouldUpdate = false;
                  // å¤„ç†æ™®é€šå†…å®¹
                  if (parsed.choices[0].delta.content) {
                    if (isKimiModel) {
                      // Kimiæ¨¡å‹ï¼šå°†æ–°å†…å®¹æ·»åŠ åˆ°å­—ç¬¦ç¼“å†²åŒº
                      characterBuffer += parsed.choices[0].delta.content;
                    } else {
                      // å…¶ä»–æ¨¡å‹ï¼šç›´æ¥æ·»åŠ åˆ°å®Œæ•´å“åº”
                      fullResponse += parsed.choices[0].delta.content;
                      shouldUpdate = true;
                    }
                  }
                  // å¤„ç†æ¨ç†å†…å®¹ï¼ˆdeepseek-reasoner ç‰¹æœ‰ï¼‰
                  if (parsed.choices[0].delta.reasoning_content) {
                    reasoningContent += parsed.choices[0].delta.reasoning_content;
                    shouldUpdate = true;
                  }
                  
                  // Kimiæ¨¡å‹ä¸“ç”¨é€å­—è¾“å‡ºå¤„ç†
                  if (isKimiModel && characterBuffer.length > 0) {
                    const currentTime = Date.now();
                    if (currentTime - lastUpdateTime >= updateThrottle) {
                      // ä»ç¼“å†²åŒºå–å‡ºä¸€ä¸ªå­—ç¬¦è¿›è¡Œè¾“å‡º
                      const nextChar = characterBuffer.charAt(0);
                      characterBuffer = characterBuffer.slice(1);
                      fullResponse += nextChar;
                      
                      updateStreamingMessage(messageId, fullResponse, false, isWebSearchResult, reasoningContent, isReasonerModel);
                      lastUpdateTime = currentTime;
                      
                      // å¦‚æœç¼“å†²åŒºè¿˜æœ‰å†…å®¹ï¼Œç»§ç»­å¤„ç†
                      if (characterBuffer.length > 0) {
                        setTimeout(() => {
                          // é€’å½’å¤„ç†å‰©ä½™å­—ç¬¦
                          const processNextChar = () => {
                            if (characterBuffer.length > 0) {
                              const char = characterBuffer.charAt(0);
                              characterBuffer = characterBuffer.slice(1);
                              fullResponse += char;
                              updateStreamingMessage(messageId, fullResponse, false, isWebSearchResult, reasoningContent, isReasonerModel);
                              
                              if (characterBuffer.length > 0) {
                                setTimeout(processNextChar, updateThrottle);
                              }
                            }
                          };
                          processNextChar();
                        }, updateThrottle);
                      }
                    }
                  }
                  
                  // å…¶ä»–æ¨¡å‹çš„æ›´æ–°é€»è¾‘
                  if (!isKimiModel && shouldUpdate) {
                    const currentTime = Date.now();
                    if (currentTime - lastUpdateTime >= updateThrottle) {
                      updateStreamingMessage(messageId, fullResponse, false, isWebSearchResult, reasoningContent, isReasonerModel);
                      lastUpdateTime = currentTime;
                    } else {
                      // å»¶è¿Ÿæ›´æ–°
                      setTimeout(() => {
                        updateStreamingMessage(messageId, fullResponse, false, isWebSearchResult, reasoningContent, isReasonerModel);
                      }, updateThrottle - (currentTime - lastUpdateTime));
                    }
                  }
                }
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        }
        
        // Kimiæ¨¡å‹ï¼šç¡®ä¿ç¼“å†²åŒºå‰©ä½™å­—ç¬¦å…¨éƒ¨è¾“å‡º
        if (isKimiModel && characterBuffer.length > 0) {
          fullResponse += characterBuffer;
          characterBuffer = '';
        }
        
        // ç¡®ä¿æœ€ç»ˆçŠ¶æ€æ˜¯å®Œæˆçš„ï¼Œå¼ºåˆ¶è¿›è¡Œæœ€åä¸€æ¬¡æ›´æ–°
        updateStreamingMessage(messageId, fullResponse || 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°å®Œæ•´å›å¤ã€‚', true, isWebSearchResult, reasoningContent, isReasonerModel);
        
      } catch (error) {
        console.error('APIè°ƒç”¨é”™è¯¯:', error);
        
        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        clearTimeout(timeoutId);
        
        // Kimiæ¨¡å‹ï¼šç¡®ä¿ç¼“å†²åŒºå‰©ä½™å­—ç¬¦å…¨éƒ¨è¾“å‡º
        if (isKimiModel && characterBuffer.length > 0) {
          fullResponse += characterBuffer;
          characterBuffer = '';
        }
        
        let errorMessage;
        // æ ¹æ®ä¸åŒé”™è¯¯ç±»å‹æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆ
        if (error.name === 'AbortError') {
          errorMessage = `è¯·æ±‚è¶…æ—¶ï¼šè¿æ¥APIæœåŠ¡è¶…è¿‡${requestTimeout/1000}ç§’ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`;
        } else if (error.message.includes('SSL') || error.message.includes('certificate') || error.message.includes('CERT')) {
          errorMessage = `SSLè¯ä¹¦é”™è¯¯ï¼šæ— æ³•å»ºç«‹å®‰å…¨è¿æ¥åˆ°APIæœåŠ¡ã€‚\n\nå¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®\n2. å°è¯•ä½¿ç”¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒ\n3. è”ç³»ç½‘ç»œç®¡ç†å‘˜æ£€æŸ¥é˜²ç«å¢™è®¾ç½®\n4. å¦‚æœä½¿ç”¨ä»£ç†ï¼Œè¯·æ£€æŸ¥ä»£ç†é…ç½®`;
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = `ç½‘ç»œè¿æ¥é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°APIæœåŠ¡ã€‚\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n2. APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n3. é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢äº†è¯·æ±‚\n4. DNSè§£æé—®é¢˜\n\nå»ºè®®ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚`;
        } else if (error.message.includes('CORS')) {
          errorMessage = `è·¨åŸŸè¯·æ±‚é”™è¯¯ï¼šæµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢äº†APIè°ƒç”¨ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨æ”¯æŒCORSçš„APIç«¯ç‚¹\n2. é…ç½®æœåŠ¡å™¨å…è®¸è·¨åŸŸè¯·æ±‚\n3. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨è½¬å‘è¯·æ±‚`;
        } else {
          // é’ˆå¯¹Kimiæ¨¡å‹çš„ç‰¹æ®Šé”™è¯¯å¤„ç†
          if (isKimiModel) {
            errorMessage = `Kimiæ¨¡å‹è°ƒç”¨å¤±è´¥ï¼š${error.message}\n\né’ˆå¯¹Kimiæ¨¡å‹çš„è§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®\n2. ç¡®è®¤ç½‘ç»œè¿æ¥ç¨³å®š\n3. å¦‚æœå‡ºç°è¾“å‡ºä¸­æ–­ï¼Œè¯·é‡æ–°å‘é€æ¶ˆæ¯\n4. å»ºè®®é™ä½temperatureå‚æ•°å€¼\n5. å°è¯•å‡å°‘å•æ¬¡å¯¹è¯çš„é•¿åº¦\n\nå¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚`;
          } else {
            errorMessage = `APIè°ƒç”¨å¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. APIæœåŠ¡æ˜¯å¦å¯ç”¨\n\nå¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
          }
        }
        
        // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å…‰æ ‡å…ƒç´ 
        const allCursors = document.querySelectorAll('.typing-cursor');
        allCursors.forEach(cursor => cursor.remove());
        
        updateStreamingMessage(messageId, errorMessage, true, false, '', false);
        
        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ²¡æœ‰æ®‹ç•™çš„å…‰æ ‡
        setTimeout(() => {
          const remainingCursors = document.querySelectorAll('.typing-cursor');
          remainingCursors.forEach(cursor => cursor.remove());
        }, 100);
      }
    }
    
    // ç”ŸæˆAIå›å¤ï¼ˆéæµå¼ï¼Œä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
    async function generateAIResponse(userMessage) {
      // è·å–ç”¨æˆ·è®¾ç½®
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const apiKey = settings.apiKey || document.getElementById('apiKey')?.value;
      let baseUrl = settings.baseUrl || document.getElementById('apiBaseUrl')?.value;
      const modelProvider = settings.model || document.getElementById('modelSelect')?.value || 'openai';
      const modelVersion = settings.modelVersion || getActualModelVersion();
      const temperature = parseFloat(settings.temperature || document.getElementById('temperature')?.value || 0.7);
      const maxTokens = parseInt(settings.maxTokens || document.getElementById('maxTokens')?.value || 2048);
      
      // æ ¹æ®æ¨¡å‹æä¾›å•†è®¾ç½®é»˜è®¤çš„baseUrl
      if (!baseUrl) {
        switch(modelProvider) {
          case 'deepseek':
            baseUrl = 'https://api.deepseek.com';
            break;
          case 'openai':
            baseUrl = 'https://api.openai.com';
            break;
          case 'anthropic':
            baseUrl = 'https://api.anthropic.com';
            break;
          case 'google':
            baseUrl = 'https://generativelanguage.googleapis.com';
            break;
          case 'xai':
            baseUrl = 'https://api.x.ai';
            break;
          case 'mistral':
            baseUrl = 'https://api.mistral.ai';
            break;
          case 'cohere':
            baseUrl = 'https://api.cohere.ai';
            break;
          case 'perplexity':
            baseUrl = 'https://api.perplexity.ai';
            break;
          case 'together':
            baseUrl = 'https://api.together.xyz';
            break;
          case 'groq':
            baseUrl = 'https://api.groq.com';
            break;
          case 'fireworks':
            baseUrl = 'https://api.fireworks.ai';
            break;
          case 'baidu':
            baseUrl = 'https://aip.baidubce.com';
            break;
          case 'ali':
            baseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
            break;
          case 'tencent':
            baseUrl = 'https://hunyuan.tencentcloudapi.com';
            break;
          case 'zhipu':
            baseUrl = 'https://open.bigmodel.cn';
            break;
          case 'moonshot':
            baseUrl = 'https://api.moonshot.cn';
            break;
          case 'minimax':
            baseUrl = 'https://api.minimax.chat';
            break;
          default:
            baseUrl = 'https://api.openai.com';
        }
      }
      
      // å¦‚æœæ²¡æœ‰é…ç½®APIå¯†é’¥ï¼Œè¿”å›æç¤ºä¿¡æ¯
      if (!apiKey) {
        return 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥ï¼Œç„¶åé‡æ–°å‘é€æ¶ˆæ¯ã€‚';
      }
      
      try {
        // æ ¹æ®ä¸åŒæä¾›å•†æ„å»ºä¸åŒçš„endpoint
        let endpoint;
        if (modelProvider === 'deepseek') {
          endpoint = baseUrl.endsWith('/') ? baseUrl + 'chat/completions' : baseUrl + '/chat/completions';
        } else {
          endpoint = baseUrl.endsWith('/') ? baseUrl + 'v1/chat/completions' : baseUrl + '/v1/chat/completions';
        }
        
        // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶æ§åˆ¶
        const abortController = new AbortController();
        const timeoutId = setTimeout(() => {
          abortController.abort();
        }, requestTimeout);
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          },
          body: JSON.stringify({
            model: modelVersion,
            messages: getFullConversationHistory(),
            temperature: temperature,
            max_tokens: maxTokens,
            stream: false,
            // Qwen3æ¨¡å‹ç‰¹æ®Šå‚æ•°æ”¯æŒ
            ...(modelVersion.includes('qwen3') && modelProvider === 'ali' ? {
              extra_body: { enable_thinking: false }
            } : {})
          }),
          // æ·»åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†é…ç½®
          signal: abortController.signal,
          mode: 'cors',
          credentials: 'omit'
        });
        
        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.choices && data.choices.length > 0) {
          return data.choices[0].message.content;
        } else {
          throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
      } catch (error) {
        console.error('APIè°ƒç”¨é”™è¯¯:', error);
        
        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        clearTimeout(timeoutId);
        
        // æ ¹æ®ä¸åŒé”™è¯¯ç±»å‹æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆ
        if (error.name === 'AbortError') {
          return `è¯·æ±‚è¶…æ—¶ï¼šè¿æ¥APIæœåŠ¡è¶…è¿‡${requestTimeout/1000}ç§’ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`;
        } else if (error.message.includes('SSL') || error.message.includes('certificate') || error.message.includes('CERT')) {
          return `SSLè¯ä¹¦é”™è¯¯ï¼šæ— æ³•å»ºç«‹å®‰å…¨è¿æ¥åˆ°APIæœåŠ¡ã€‚\n\nå¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®\n2. å°è¯•ä½¿ç”¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒ\n3. è”ç³»ç½‘ç»œç®¡ç†å‘˜æ£€æŸ¥é˜²ç«å¢™è®¾ç½®\n4. å¦‚æœä½¿ç”¨ä»£ç†ï¼Œè¯·æ£€æŸ¥ä»£ç†é…ç½®`;
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
          return `ç½‘ç»œè¿æ¥é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°APIæœåŠ¡ã€‚\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n2. APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n3. é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢äº†è¯·æ±‚\n4. DNSè§£æé—®é¢˜\n\nå»ºè®®ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚`;
        } else if (error.message.includes('CORS')) {
          return `è·¨åŸŸè¯·æ±‚é”™è¯¯ï¼šæµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢äº†APIè°ƒç”¨ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨æ”¯æŒCORSçš„APIç«¯ç‚¹\n2. é…ç½®æœåŠ¡å™¨å…è®¸è·¨åŸŸè¯·æ±‚\n3. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨è½¬å‘è¯·æ±‚`;
        } else {
          return `APIè°ƒç”¨å¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. APIæœåŠ¡æ˜¯å¦å¯ç”¨\n\nå¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
        }
      }
    }
    
    // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
    function switchSettingsTab(tabName) {
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
      settingsTabs.forEach(tab => {
        tab.classList.remove('bg-primary', 'text-white');
        tab.classList.add('text-neutral-600', 'hover:text-neutral-800');
      });
      
      // éšè—æ‰€æœ‰å†…å®¹
      settingsContents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
      const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('bg-primary', 'text-white');
        activeTab.classList.remove('text-neutral-600', 'hover:text-neutral-800');
      }
      
      // æ˜¾ç¤ºå¯¹åº”å†…å®¹
      const activeContent = document.getElementById(`${tabName}Tab`);
      if (activeContent) {
        activeContent.classList.remove('hidden');
      }
    }
    
    // é€šçŸ¥ç³»ç»Ÿ
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-xl shadow-lg animate-slide-up`;
      
      switch (type) {
        case 'success':
          notification.classList.add('bg-green-500', 'text-white');
          break;
        case 'error':
          notification.classList.add('bg-red-500', 'text-white');
          break;
        case 'warning':
          notification.classList.add('bg-yellow-500', 'text-white');
          break;
        default:
          notification.classList.add('bg-blue-500', 'text-white');
      }
      
      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fa fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // è®¾ç½®ç®¡ç†
    function saveAllSettings() {
      const settings = {
        model: document.getElementById('modelSelect')?.value || 'openai',
        modelVersion: getActualModelVersion(),
        apiKey: document.getElementById('apiKey')?.value || '',
        baseUrl: document.getElementById('apiBaseUrl')?.value || '',
        temperature: document.getElementById('temperature')?.value || 0.7,
        maxTokens: document.getElementById('maxTokens')?.value || 2048,
        webAccess: document.getElementById('webAccess')?.checked || false,
        autoToolCalling: document.getElementById('autoToolCalling')?.checked || false,
        voiceInput: document.getElementById('voiceInput')?.checked || false,
        markdownRender: document.getElementById('markdownToggle')?.checked || true,
        darkMode: document.getElementById('darkMode')?.checked || false,
        animations: document.getElementById('animations')?.checked || true,
        quickReplies: document.getElementById('quickReplies')?.checked || true,
        requestTimeout: document.getElementById('requestTimeout')?.value || 30,
        maxRetries: document.getElementById('maxRetries')?.value || 3,
        historyLimit: document.getElementById('historyLimit')?.value || 100,
        debugMode: document.getElementById('debugMode')?.checked || false,
        apiLogging: document.getElementById('apiLogging')?.checked || false
      };
      
      localStorage.setItem('chatSettings', JSON.stringify(settings));
    }
    
    function resetAllSettings() {
      localStorage.removeItem('chatSettings');
      location.reload();
    }
    
    function loadSettings() {
      const savedSettings = localStorage.getItem('chatSettings');
      if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        
        // åº”ç”¨ä¿å­˜çš„è®¾ç½®
        Object.keys(settings).forEach(key => {
          const element = document.getElementById(key);
          if (element) {
            if (element.type === 'checkbox') {
              element.checked = settings[key];
            } else {
              element.value = settings[key];
            }
          }
        });
      }
    }
    
    // èŠå¤©è®°å½•ç®¡ç†
    function clearChatHistory() {
      if (!chatContainer) return;
      
      // æ¸…ç©ºå¯¹è¯å†å²è®°å½•
      conversationHistory = [];
      
      chatContainer.innerHTML = `
        <div class="text-center py-12 animate-fade-in">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-primary/10 flex items-center justify-center">
            <i class="fa fa-comments text-2xl text-primary"></i>
          </div>
          <h2 class="text-xl font-semibold text-neutral-800 mb-2">æ¬¢è¿ä½¿ç”¨æ™ºèƒ½åŠ©æ‰‹</h2>
          <p class="text-neutral-600 mb-6">æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”é—®é¢˜ã€å¤„ç†ä»»åŠ¡ï¼Œè®©æˆ‘ä»¬å¼€å§‹å¯¹è¯å§ï¼</p>
          
          <div class="flex flex-wrap gap-2 justify-center mb-8">
            <span class="px-3 py-1 bg-primary/10 text-primary rounded-full text-sm">ğŸ’¡ åˆ›æ„çµæ„Ÿ</span>
            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">ğŸ“ æ–‡æ¡ˆå†™ä½œ</span>
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ğŸ” ä¿¡æ¯æŸ¥è¯¢</span>
            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">ğŸ§® æ•°æ®åˆ†æ</span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
            <div class="p-4 border border-neutral-200 rounded-xl hover:border-primary/30 transition-colors cursor-pointer" onclick="fillQuickMessage('å¸®æˆ‘å†™ä¸€ä»½å·¥ä½œæ€»ç»“')">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa fa-lightbulb-o text-yellow-500"></i>
                <span class="font-medium text-neutral-800">åˆ›æ„å¯å‘</span>
              </div>
              <p class="text-sm text-neutral-600">å¸®æˆ‘å†™ä¸€ä»½å·¥ä½œæ€»ç»“</p>
            </div>
            
            <div class="p-4 border border-neutral-200 rounded-xl hover:border-primary/30 transition-colors cursor-pointer" onclick="fillQuickMessage('è§£é‡Šä¸€ä¸‹æœºå™¨å­¦ä¹ çš„åŸºæœ¬æ¦‚å¿µ')">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa fa-graduation-cap text-blue-500"></i>
                <span class="font-medium text-neutral-800">å­¦ä¹ æŒ‡å¯¼</span>
              </div>
              <p class="text-sm text-neutral-600">è§£é‡Šä¸€ä¸‹æœºå™¨å­¦ä¹ çš„åŸºæœ¬æ¦‚å¿µ</p>
            </div>
            
            <div class="p-4 border border-neutral-200 rounded-xl hover:border-primary/30 transition-colors cursor-pointer" onclick="fillQuickMessage('å¸®æˆ‘åˆ†æè¿™ç»„æ•°æ®çš„è¶‹åŠ¿')">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa fa-bar-chart text-green-500"></i>
                <span class="font-medium text-neutral-800">æ•°æ®åˆ†æ</span>
              </div>
              <p class="text-sm text-neutral-600">å¸®æˆ‘åˆ†æè¿™ç»„æ•°æ®çš„è¶‹åŠ¿</p>
            </div>
            
            <div class="p-4 border border-neutral-200 rounded-xl hover:border-primary/30 transition-colors cursor-pointer" onclick="fillQuickMessage('æœ‰ä»€ä¹ˆé—®é¢˜æˆ‘éƒ½å¯ä»¥å¸®æ‚¨è§£ç­”')">
              <div class="flex items-center gap-3 mb-2">
                <i class="fa fa-question-circle text-purple-500"></i>
                <span class="font-medium text-neutral-800">é€šç”¨é—®ç­”</span>
              </div>
              <p class="text-sm text-neutral-600">æœ‰ä»€ä¹ˆé—®é¢˜æˆ‘éƒ½å¯ä»¥å¸®æ‚¨è§£ç­”</p>
            </div>
          </div>
        </div>
      `;
    }
    
    function exportChatHistory() {
      if (!chatContainer) return;
      
      const messages = Array.from(chatContainer.children).map(msg => {
        const text = msg.querySelector('p')?.textContent || '';
        const isUser = msg.classList.contains('justify-end');
        return {
          sender: isUser ? 'user' : 'ai',
          message: text,
          timestamp: new Date().toISOString()
        };
      });
      
      const dataStr = JSON.stringify(messages, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `chat-history-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      showNotification('èŠå¤©è®°å½•å·²å¯¼å‡º', 'success');
    }
    
    // å…¨å±åŠŸèƒ½
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="fa fa-compress"></i>';
      } else {
        document.exitFullscreen();
        if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i>';
      }
    }
    
    // é™„ä»¶å¤„ç†
    function handleAttachment() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.accept = '.txt,.pdf,.doc,.docx,.jpg,.png,.gif';
      
      input.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          showNotification(`å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`, 'info');
          // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶å¤„ç†é€»è¾‘
        }
      };
      
      input.click();
    }
    
    // è¯­éŸ³è¾“å…¥å˜é‡
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    
    // è¯­éŸ³è¾“å…¥
    function toggleVoiceInput() {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }
    
    // å¼€å§‹å½•éŸ³
    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioChunks = [];
          mediaRecorder = new MediaRecorder(stream);
          
          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };
          
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            transcribeAudio(audioBlob);
            stream.getTracks().forEach(track => track.stop());
          };
          
          mediaRecorder.start();
          isRecording = true;
          
          if (voiceBtn) voiceBtn.innerHTML = '<i class="fa fa-stop text-red-500"></i>';
          showNotification('æ­£åœ¨å½•éŸ³...', 'info');
        })
        .catch(error => {
          console.error('è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
          showNotification('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
        });
    }
    
    // åœæ­¢å½•éŸ³
    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        if (voiceBtn) voiceBtn.innerHTML = '<i class="fa fa-microphone"></i>';
        showNotification('å½•éŸ³ç»“æŸï¼Œæ­£åœ¨è½¬å½•...', 'info');
      }
    }
    
    // éŸ³é¢‘è½¬å½•
    function transcribeAudio(audioBlob) {
      const formData = new FormData();
      formData.append('file', audioBlob, 'audio.wav');
      formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
      
      fetch('https://api.siliconflow.cn/v1/audio/transcriptions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer sk-rtambershukoehkbwyuzjgmchimiuvccavobzqzkiqdbzlxz'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.text) {
          if (messageInput) messageInput.value = data.text;
          showNotification('è¯­éŸ³è½¬å½•å®Œæˆ', 'success');
        } else {
          showNotification('è½¬å½•ç»“æœä¸ºç©º', 'warning');
        }
      })
      .catch(error => {
        console.error('éŸ³é¢‘è½¬å½•å¤±è´¥:', error);
        showNotification('éŸ³é¢‘è½¬å½•å¤±è´¥: ' + error.message, 'error');
      });
    }
    
    // å¿«é€Ÿæ¶ˆæ¯å¡«å……
    function fillQuickMessage(message) {
      if (!messageInput) return;
      
      messageInput.value = message;
      messageInput.focus();
    }
    
    // å¯†ç å¯è§æ€§åˆ‡æ¢
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const button = input?.nextElementSibling;
      const icon = button?.querySelector('i');
      
      if (!input || !icon) return;
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fa fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fa fa-eye';
      }
    }
    
    // APIè¿æ¥æµ‹è¯•
    function testAPIConnection() {
      const apiKey = document.getElementById('apiKey')?.value;
      const baseUrl = document.getElementById('apiBaseUrl')?.value;
      const modelProvider = document.getElementById('modelSelect')?.value;
      const modelVersion = getActualModelVersion();
      
      if (!apiKey) {
        showNotification('è¯·å…ˆè¾“å…¥APIå¯†é’¥', 'warning');
        return;
      }
      
      // å¦‚æœæ²¡æœ‰è¾“å…¥baseUrlï¼Œä½¿ç”¨é»˜è®¤å€¼
      let finalBaseUrl = baseUrl;
      if (!finalBaseUrl) {
        switch(modelProvider) {
          case 'deepseek':
            finalBaseUrl = 'https://api.deepseek.com';
            break;
          case 'openai':
            finalBaseUrl = 'https://api.openai.com';
            break;
          case 'anthropic':
            finalBaseUrl = 'https://api.anthropic.com';
            break;
          case 'google':
            finalBaseUrl = 'https://generativelanguage.googleapis.com';
            break;
          case 'xai':
            finalBaseUrl = 'https://api.x.ai';
            break;
          case 'mistral':
            finalBaseUrl = 'https://api.mistral.ai';
            break;
          case 'cohere':
            finalBaseUrl = 'https://api.cohere.ai';
            break;
          case 'perplexity':
            finalBaseUrl = 'https://api.perplexity.ai';
            break;
          case 'together':
            finalBaseUrl = 'https://api.together.xyz';
            break;
          case 'groq':
            finalBaseUrl = 'https://api.groq.com';
            break;
          case 'fireworks':
            finalBaseUrl = 'https://api.fireworks.ai';
            break;
          case 'baidu':
            finalBaseUrl = 'https://aip.baidubce.com';
            break;
          case 'ali':
            finalBaseUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1';
            break;
          case 'tencent':
            finalBaseUrl = 'https://hunyuan.tencentcloudapi.com';
            break;
          case 'zhipu':
            finalBaseUrl = 'https://open.bigmodel.cn';
            break;
          case 'moonshot':
            finalBaseUrl = 'https://api.moonshot.cn';
            break;
          case 'minimax':
            finalBaseUrl = 'https://api.minimax.chat';
            break;
          default:
            finalBaseUrl = 'https://api.openai.com';
        }
      }
      
      // éªŒè¯URLæ ¼å¼
      try {
        new URL(finalBaseUrl);
      } catch (e) {
        showNotification('åŸºç¡€URLæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„URL', 'error');
        return;
      }
      
      showNotification('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
      
      // æ ¹æ®ä¸åŒæä¾›å•†æ„å»ºä¸åŒçš„æµ‹è¯•ç«¯ç‚¹
      let testEndpoint;
      if (modelProvider === 'deepseek') {
        testEndpoint = finalBaseUrl.endsWith('/') ? finalBaseUrl + 'models' : finalBaseUrl + '/models';
      } else {
        testEndpoint = finalBaseUrl.endsWith('/') ? finalBaseUrl + 'v1/models' : finalBaseUrl + '/v1/models';
      }
      
      fetch(testEndpoint, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          showNotification(`è¿æ¥æˆåŠŸï¼æ¨¡å‹ ${modelVersion} å¯æ­£å¸¸ä½¿ç”¨`, 'success');
        } else if (response.status === 401) {
          showNotification('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®', 'error');
        } else if (response.status === 404) {
          showNotification('APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åŸºç¡€URL', 'error');
        } else {
          showNotification(`è¿æ¥å¤±è´¥ï¼šHTTP ${response.status}`, 'error');
        }
      })
      .catch(error => {
        // ç”±äºCORSé™åˆ¶ï¼Œå¯èƒ½ä¼šå¤±è´¥ï¼Œæä¾›å¤‡ç”¨éªŒè¯
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          // åŸºæœ¬æ ¼å¼éªŒè¯
          if (apiKey.length < 10) {
            showNotification('APIå¯†é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼ˆé•¿åº¦è¿‡çŸ­ï¼‰', 'warning');
          } else if (!baseUrl.startsWith('http')) {
            showNotification('åŸºç¡€URLå¿…é¡»ä»¥http://æˆ–https://å¼€å¤´', 'error');
          } else {
            showNotification('è¿æ¥æµ‹è¯•å®Œæˆï¼Œé…ç½®æ ¼å¼æ­£ç¡®ï¼ˆå¯èƒ½å—CORSé™åˆ¶å½±å“å®é™…è¿æ¥æµ‹è¯•ï¼‰', 'success');
          }
        } else {
          showNotification('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message, 'error');
        }
      });
    }
    
    // å·¥å…·æŒ‰é’®äº‹ä»¶ç›‘å¬
    function addToolButtonListeners() {
      // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
      setTimeout(() => {
        // è·å–å·¥å…·é¢æ¿ä¸­çš„æ‰€æœ‰æŒ‰é’®
        const toolButtons = document.querySelectorAll('#toolsPanel .p-2 button');
        
        toolButtons.forEach(button => {
          const icon = button.querySelector('i');
          const span = button.querySelector('span');
          
          if (!icon || !span) return;
          
          // åªä¿ç•™ä»£ç è§£é‡Šå™¨åŠŸèƒ½
          if (icon.classList.contains('fa-code')) {
            button.addEventListener('click', () => {
              showToolResult('ä»£ç è§£é‡Šå™¨', executeCodeInterpreter());
              if (toolsPanel) toolsPanel.style.display = 'none';
            });
          }
        });
      }, 100);
    }
    
    // å¿«æ·å›å¤æŒ‰é’®äº‹ä»¶
    function addQuickReplyListeners() {
      const suggestionCards = document.querySelectorAll('.suggestion-card');
      suggestionCards.forEach(card => {
        card.addEventListener('click', () => {
          const textElement = card.querySelector('p');
          const text = textElement ? textElement.textContent.trim() : '';
          if (messageInput && text) {
            messageInput.value = text;
            messageInput.focus();
            // è‡ªåŠ¨å‘é€å¿«é€Ÿå›å¤æ¶ˆæ¯
            setTimeout(() => {
              sendMessage();
            }, 100);
          }
        });
      });
    }
    
    // æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ
    function showToolResult(toolName, result) {
      const toolResultPanel = document.getElementById('toolResultPanel');
      const toolResultContent = document.getElementById('toolResultContent');
      
      if (toolResultPanel && toolResultContent) {
        toolResultContent.innerHTML = result;
        toolResultPanel.style.display = 'flex';
      }
    }
    

    
    // ä»£ç è§£é‡Šå™¨å·¥å…·æ‰§è¡Œ
    function executeCodeInterpreter() {
      return `
        <div class="space-y-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
              <i class="fa fa-code text-green-600"></i>
            </div>
            <div>
              <h3 class="font-medium text-neutral-800">ä»£ç è§£é‡Šå™¨</h3>
              <p class="text-sm text-neutral-600">è¿è¡Œä»£ç ç‰‡æ®µ</p>
            </div>
          </div>
          
          <div class="bg-neutral-50 rounded-xl p-4 mb-4">
            <p class="text-neutral-700 font-medium mb-2">ä»£ç è¾“å…¥ï¼š</p>
            <textarea id="codeInput" placeholder="è¾“å…¥JavaScriptä»£ç ..." class="w-full h-32 px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 font-mono text-sm"></textarea>
            <button onclick="executeCode()" class="mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">è¿è¡Œä»£ç </button>
          </div>
          
          <div id="codeResult" class="border border-neutral-200 rounded-xl p-4">
            <p class="text-neutral-700 font-medium mb-2">æ‰§è¡Œç»“æœï¼š</p>
            <pre class="bg-neutral-800 text-green-400 p-3 rounded-lg text-sm font-mono">ç­‰å¾…ä»£ç æ‰§è¡Œ...</pre>
          </div>
        </div>
      `;
    }
    

    
    // åˆå§‹åŒ–
    function init() {
      initEventListeners();
      loadSettings();
      // é»˜è®¤æ˜¾ç¤ºæ¨¡å‹é…ç½®æ ‡ç­¾é¡µ
      switchSettingsTab('model');
      
      // æ·»åŠ å·¥å…·æŒ‰é’®äº‹ä»¶
      addToolButtonListeners();
      
      // æ·»åŠ å¿«æ·å›å¤äº‹ä»¶
      addQuickReplyListeners();
      
      // è¿æ¥æµ‹è¯•æŒ‰é’®
      const testConnectionBtn = document.getElementById('testConnection');
      if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', testAPIConnection);
      }
      
      // ä¿å­˜æ¨¡å‹é…ç½®æŒ‰é’®
      const saveModelConfigBtn = document.getElementById('saveModelConfig');
      if (saveModelConfigBtn) {
        saveModelConfigBtn.addEventListener('click', () => {
          saveAllSettings();
          showNotification('æ¨¡å‹é…ç½®å·²ä¿å­˜', 'success');
        });
      }
    }
    
    // å·¥å…·æ‰§è¡Œå‡½æ•°
    
    function executeCode() {
      const input = document.getElementById('codeInput');
      const result = document.getElementById('codeResult');
      
      if (!input || !result) return;
      
      const code = input.value.trim();
      if (!code) {
        result.innerHTML = `
          <p class="text-neutral-700 font-medium mb-2">æ‰§è¡Œç»“æœï¼š</p>
          <pre class="bg-neutral-800 text-red-400 p-3 rounded-lg text-sm font-mono">è¯·è¾“å…¥ä»£ç </pre>
        `;
        return;
      }
      
      try {
        // é‡å®šå‘console.logè¾“å‡º
        let output = '';
        const originalLog = console.log;
        console.log = (...args) => {
          output += args.join(' ') + '\n';
        };
        
        // æ‰§è¡Œä»£ç 
        const execResult = Function(code)();
        
        // æ¢å¤console.log
        console.log = originalLog;
        
        let displayResult = output || (execResult !== undefined ? String(execResult) : 'ä»£ç æ‰§è¡Œå®Œæˆ');
        
        result.innerHTML = `
          <p class="text-neutral-700 font-medium mb-2">æ‰§è¡Œç»“æœï¼š</p>
          <pre class="bg-neutral-800 text-green-400 p-3 rounded-lg text-sm font-mono">${displayResult}</pre>
        `;
      } catch (error) {
        result.innerHTML = `
          <p class="text-neutral-700 font-medium mb-2">æ‰§è¡Œç»“æœï¼š</p>
          <pre class="bg-neutral-800 text-red-400 p-3 rounded-lg text-sm font-mono">é”™è¯¯ï¼š${error.message}</pre>
        `;
      }
    }
    


    
    // æ¶ˆæ¯æ“ä½œå‡½æ•°
    function regenerateMessage(messageId) {
      const messageElement = document.getElementById(messageId);
      if (!messageElement) return;
      
      // ä»å¯¹è¯å†å²ä¸­æ‰¾åˆ°å¯¹åº”çš„AIå›å¤ç´¢å¼•
      let aiMessageIndex = -1;
      for (let i = conversationHistory.length - 1; i >= 0; i--) {
        if (conversationHistory[i].role === 'assistant') {
          aiMessageIndex = i;
          break;
        }
      }
      
      if (aiMessageIndex === -1) {
        showNotification('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯è®°å½•', 'error');
        return;
      }
      
      // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆåº”è¯¥åœ¨AIæ¶ˆæ¯ä¹‹å‰ï¼‰
      let userMessage = '';
      for (let i = aiMessageIndex - 1; i >= 0; i--) {
        if (conversationHistory[i].role === 'user') {
          userMessage = conversationHistory[i].content;
          break;
        }
      }
      
      if (!userMessage) {
        showNotification('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯', 'error');
        return;
      }
      
      // ç§»é™¤å½“å‰AIæ¶ˆæ¯å’Œå¯¹è¯å†å²ä¸­çš„è®°å½•
      messageElement.remove();
      conversationHistory.splice(aiMessageIndex, 1);
      
      showNotification('æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...', 'info');
      
      // é‡æ–°ç”ŸæˆAIå›å¤
      const newMessageId = 'ai-message-' + Date.now();
      addStreamingMessage(newMessageId);
      
      // è°ƒç”¨AIç”Ÿæˆå‡½æ•°
      generateAIResponseStreaming(userMessage, newMessageId).then(() => {
        showNotification('å›å¤å·²é‡æ–°ç”Ÿæˆ', 'success');
      }).catch((error) => {
        console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
        showNotification('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        // ç§»é™¤å¤±è´¥çš„æ¶ˆæ¯å®¹å™¨
        const failedElement = document.getElementById(newMessageId);
        if (failedElement) {
          failedElement.remove();
        }
      });
    }
    
    function copyMessage(messageId) {
      const messageElement = document.getElementById(messageId);
      if (!messageElement) return;
      
      const contentElement = messageElement.querySelector('.markdown-content');
      if (!contentElement) return;
      
      // è·å–çº¯æ–‡æœ¬å†…å®¹
      const textContent = contentElement.innerText || contentElement.textContent;
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(textContent).then(() => {
        showNotification('æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        
        // ä¸´æ—¶æ”¹å˜æŒ‰é’®å›¾æ ‡
        const copyBtn = messageElement.querySelector('[onclick*="copyMessage"] i');
        if (copyBtn) {
          const originalClass = copyBtn.className;
          copyBtn.className = 'fa fa-check text-xs';
          setTimeout(() => {
            copyBtn.className = originalClass;
          }, 2000);
        }
      }).catch(() => {
        showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬', 'error');
      });
    }
    
    function copyCodeBlock(codeId) {
      const codeElement = document.getElementById(codeId);
      if (!codeElement) return;
      
      // è·å–ä»£ç å†…å®¹
      const codeContent = codeElement.textContent || codeElement.innerText;
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(codeContent).then(() => {
        showNotification('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        
        // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡æœ¬å’Œå›¾æ ‡
        const copyBtn = codeElement.closest('.code-block-container').querySelector('.copy-code-btn');
        if (copyBtn) {
          const originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fa fa-check"></i><span>å·²å¤åˆ¶</span>';
          copyBtn.classList.add('bg-green-200', 'text-green-700');
          copyBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          
          setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.classList.remove('bg-green-200', 'text-green-700');
            copyBtn.classList.add('bg-gray-200', 'hover:bg-gray-300');
          }, 2000);
        }
      }).catch(() => {
        showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä»£ç ', 'error');
      });
    }
    
    function favoriteMessage(messageId) {
      const messageElement = document.getElementById(messageId);
      if (!messageElement) return;
      
      const favoriteBtn = messageElement.querySelector('[onclick*="favoriteMessage"] i');
      if (!favoriteBtn) return;
      
      // åˆ‡æ¢æ”¶è—çŠ¶æ€
      const isFavorited = favoriteBtn.classList.contains('fa-heart');
      
      if (isFavorited) {
        favoriteBtn.className = 'fa fa-heart-o text-xs';
        showNotification('å·²å–æ¶ˆæ”¶è—', 'info');
      } else {
        favoriteBtn.className = 'fa fa-heart text-xs';
        favoriteBtn.style.color = '#ef4444';
        showNotification('å·²æ·»åŠ åˆ°æ”¶è—', 'success');
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        const contentElement = messageElement.querySelector('.markdown-content');
        if (contentElement) {
          const favorites = JSON.parse(localStorage.getItem('favoriteMessages') || '[]');
          favorites.push({
            id: messageId,
            content: contentElement.innerText || contentElement.textContent,
            timestamp: Date.now()
          });
          localStorage.setItem('favoriteMessages', JSON.stringify(favorites));
        }
      }
    }
    
    // æ¨ç†è¿‡ç¨‹å±•å¼€/æ”¶èµ·åŠŸèƒ½
    function toggleReasoning(button) {
      const reasoningSection = button.closest('.reasoning-section');
      if (!reasoningSection) return;
      
      const reasoningContent = reasoningSection.querySelector('.reasoning-content');
      const toggleIcon = button.querySelector('i');
      
      if (!reasoningContent || !toggleIcon) return;
      
      const isCollapsed = reasoningContent.style.display === 'none';
      
      if (isCollapsed) {
        // å±•å¼€
        reasoningContent.style.display = 'block';
        toggleIcon.className = 'fa fa-chevron-up text-xs';
        reasoningSection.style.maxHeight = 'none';
      } else {
        // æ”¶èµ·
        reasoningContent.style.display = 'none';
        toggleIcon.className = 'fa fa-chevron-down text-xs';
        reasoningSection.style.maxHeight = '60px';
      }
    }
    
    // å¤´åƒç›¸å…³å‡½æ•°
    function getUserAvatar() {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const userAvatarUrl = settings.userAvatarUrl;
      
      if (userAvatarUrl) {
        return `<div class="w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-700 flex-shrink-0 overflow-hidden">
                  <img src="${userAvatarUrl}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <i class="fa fa-user" style="display:none;"></i>
                </div>`;
      } else {
        return `<div class="w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-700 flex-shrink-0">
                  <i class="fa fa-user"></i>
                </div>`;
      }
    }
    
    function getAIAvatar() {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const currentModel = settings.model || document.getElementById('modelSelect')?.value || 'openai';
      const aiAvatars = settings.aiAvatars || {};
      const avatarUrl = aiAvatars[currentModel];
      
      if (avatarUrl) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯emoji
        if (avatarUrl.length <= 4 && /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(avatarUrl)) {
          return `<div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0 text-lg">
                    ${avatarUrl}
                  </div>`;
        } else {
          return `<div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0 overflow-hidden">
                    <img src="${avatarUrl}" alt="AIå¤´åƒ" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <i class="fa fa-robot" style="display:none;"></i>
                  </div>`;
        }
      } else {
        return `<div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0">
                  <i class="fa fa-robot"></i>
                </div>`;
      }
    }
    
    function updateAvatarPreview() {
      const userAvatarUrl = document.getElementById('userAvatarUrl').value;
      const aiAvatarUrl = document.getElementById('aiAvatarUrl').value;
      const userPreview = document.getElementById('userAvatarPreview');
      const aiPreview = document.getElementById('aiAvatarPreview');
      
      // æ›´æ–°ç”¨æˆ·å¤´åƒé¢„è§ˆ
      if (userAvatarUrl) {
        userPreview.innerHTML = `<img src="${userAvatarUrl}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <i class="fa fa-user" style="display:none;"></i>`;
      } else {
        userPreview.innerHTML = '<i class="fa fa-user"></i>';
      }
      
      // æ›´æ–°AIå¤´åƒé¢„è§ˆ
      if (aiAvatarUrl) {
        if (aiAvatarUrl.length <= 4 && /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(aiAvatarUrl)) {
          aiPreview.innerHTML = aiAvatarUrl;
          aiPreview.className = 'w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0 text-xl';
        } else {
          aiPreview.innerHTML = `<img src="${aiAvatarUrl}" alt="AIå¤´åƒ" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <i class="fa fa-robot" style="display:none;"></i>`;
          aiPreview.className = 'w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0 overflow-hidden';
        }
      } else {
        aiPreview.innerHTML = '<i class="fa fa-robot"></i>';
        aiPreview.className = 'w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white flex-shrink-0';
      }
    }
    
    function loadAvatarSettings() {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const userAvatarUrl = settings.userAvatarUrl || '';
      const aiAvatars = settings.aiAvatars || {};
      const currentModel = document.getElementById('avatarModelSelect').value;
      
      document.getElementById('userAvatarUrl').value = userAvatarUrl;
      document.getElementById('aiAvatarUrl').value = aiAvatars[currentModel] || '';
      
      updateAvatarPreview();
    }
    
    function saveAvatarSettings() {
      const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
      const userAvatarUrl = document.getElementById('userAvatarUrl').value;
      const aiAvatarUrl = document.getElementById('aiAvatarUrl').value;
      const currentModel = document.getElementById('avatarModelSelect').value;
      
      settings.userAvatarUrl = userAvatarUrl;
      if (!settings.aiAvatars) settings.aiAvatars = {};
      settings.aiAvatars[currentModel] = aiAvatarUrl;
      
      localStorage.setItem('chatSettings', JSON.stringify(settings));
      updateAvatarPreview();
      showNotification('å¤´åƒè®¾ç½®å·²ä¿å­˜', 'success');
    }
    
    function resetUserAvatar() {
      document.getElementById('userAvatarUrl').value = '';
      saveAvatarSettings();
    }
    
    function resetAiAvatar() {
      document.getElementById('aiAvatarUrl').value = '';
      saveAvatarSettings();
    }
    
    function handleFileUpload(inputId, isUser = true) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const dataUrl = e.target.result;
            if (isUser) {
              document.getElementById('userAvatarUrl').value = dataUrl;
            } else {
              document.getElementById('aiAvatarUrl').value = dataUrl;
            }
            saveAvatarSettings();
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }
    
    function setPresetAvatar(emoji) {
      document.getElementById('aiAvatarUrl').value = emoji;
      saveAvatarSettings();
    }
    
    // ä»£ç å—å¤åˆ¶åŠŸèƒ½
    function copyCodeBlock(codeId) {
      const codeElement = document.getElementById(codeId);
      if (!codeElement) return;
      
      // ä¼˜å…ˆä½¿ç”¨ data-raw-code å±æ€§ä¸­çš„åŸå§‹ä»£ç 
      const rawCode = codeElement.getAttribute('data-raw-code');
      const textToCopy = rawCode || codeElement.textContent;
      
      navigator.clipboard.writeText(textToCopy).then(() => {
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const button = codeElement.closest('.code-block-container').querySelector('.copy-code-btn');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa fa-check"></i><span>å·²å¤åˆ¶</span>';
        button.classList.add('bg-green-200', 'text-green-800');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('bg-green-200', 'text-green-800');
        }, 2000);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showNotification('å¤åˆ¶å¤±è´¥', 'error');
      });
    }
    

    
    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', init);
    
    // è‡ªå®šä¹‰æ¨¡å‹åç§°åŠŸèƒ½
    function handleModelVersionChange() {
      const modelVersion = document.getElementById('modelVersion');
      const customModelInput = document.getElementById('customModelInput');
      
      if (modelVersion && customModelInput) {
        if (modelVersion.value === 'custom') {
          customModelInput.classList.remove('hidden');
          document.getElementById('customModelName').focus();
        } else {
          customModelInput.classList.add('hidden');
        }
      }
    }
    
    // è·å–å®é™…ä½¿ç”¨çš„æ¨¡å‹åç§°
    function getActualModelVersion() {
      const modelVersion = document.getElementById('modelVersion')?.value;
      if (modelVersion === 'custom') {
        return document.getElementById('customModelName')?.value || 'gpt-3.5-turbo';
      }
      return modelVersion || 'gpt-3.5-turbo';
    }
    
    // å¤´åƒç›¸å…³äº‹ä»¶ç›‘å¬
    document.addEventListener('DOMContentLoaded', function() {
      // æ¨¡å‹ç‰ˆæœ¬é€‰æ‹©å˜åŒ–ç›‘å¬
      const modelVersionSelect = document.getElementById('modelVersion');
      if (modelVersionSelect) {
        modelVersionSelect.addEventListener('change', handleModelVersionChange);
      }
      
      // å¤´åƒURLè¾“å…¥æ¡†å˜åŒ–ç›‘å¬
      const userAvatarUrl = document.getElementById('userAvatarUrl');
      const aiAvatarUrl = document.getElementById('aiAvatarUrl');
      const avatarModelSelect = document.getElementById('avatarModelSelect');
      
      if (userAvatarUrl) {
        userAvatarUrl.addEventListener('input', updateAvatarPreview);
        userAvatarUrl.addEventListener('blur', saveAvatarSettings);
      }
      
      if (aiAvatarUrl) {
        aiAvatarUrl.addEventListener('input', updateAvatarPreview);
        aiAvatarUrl.addEventListener('blur', saveAvatarSettings);
      }
      
      if (avatarModelSelect) {
        avatarModelSelect.addEventListener('change', loadAvatarSettings);
      }
      
      // ä¸Šä¼ æŒ‰é’®äº‹ä»¶
      const uploadUserAvatar = document.getElementById('uploadUserAvatar');
      const uploadAiAvatar = document.getElementById('uploadAiAvatar');
      const resetUserAvatarBtn = document.getElementById('resetUserAvatar');
      const resetAiAvatarBtn = document.getElementById('resetAiAvatar');
      
      if (uploadUserAvatar) {
        uploadUserAvatar.addEventListener('click', () => handleFileUpload('userAvatarUrl', true));
      }
      
      if (uploadAiAvatar) {
        uploadAiAvatar.addEventListener('click', () => handleFileUpload('aiAvatarUrl', false));
      }
      
      if (resetUserAvatarBtn) {
        resetUserAvatarBtn.addEventListener('click', resetUserAvatar);
      }
      
      if (resetAiAvatarBtn) {
        resetAiAvatarBtn.addEventListener('click', resetAiAvatar);
      }
      
      // é¢„è®¾å¤´åƒç‚¹å‡»äº‹ä»¶
      const presetAvatars = document.querySelectorAll('.preset-avatar');
      presetAvatars.forEach(btn => {
        btn.addEventListener('click', function() {
          const emoji = this.getAttribute('data-avatar');
          setPresetAvatar(emoji);
        });
      });
      
      // åˆå§‹åŒ–å¤´åƒè®¾ç½®
      setTimeout(() => {
        if (document.getElementById('avatarModelSelect')) {
          loadAvatarSettings();
        }
      }, 100);
    });
  </script>
</body>
</html>