<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¿æ¥è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ APIè¿æ¥è¯Šæ–­å·¥å…·</h1>
            <p>å¸®åŠ©æ‚¨è¯Šæ–­å’Œè§£å†³APIè¿æ¥é—®é¢˜</p>
        </div>

        <div class="status error">
            <strong>æ£€æµ‹åˆ°çš„é—®é¢˜ï¼š</strong> net::ERR_CONNECTION_RESET https://api.deepseek.com/chat/completions
        </div>

        <div class="form-group">
            <label for="provider">é€‰æ‹©APIæä¾›å•†ï¼š</label>
            <select id="provider" onchange="updateDefaults()">
                <option value="deepseek">DeepSeek</option>
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic</option>
            </select>
        </div>

        <div class="form-group">
            <label for="apiKey">APIå¯†é’¥ï¼š</label>
            <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥">
            <small>è¯·ç¡®ä¿APIå¯†é’¥æ ¼å¼æ­£ç¡®ä¸”æœ‰æ•ˆ</small>
        </div>

        <div class="form-group">
            <label for="baseUrl">APIåŸºç¡€URLï¼š</label>
            <input type="url" id="baseUrl" placeholder="https://api.deepseek.com">
            <small>ç•™ç©ºå°†ä½¿ç”¨é»˜è®¤åœ°å€</small>
        </div>

        <div class="form-group">
            <label for="model">æ¨¡å‹ç‰ˆæœ¬ï¼š</label>
            <select id="model">
                <option value="deepseek-chat">deepseek-chat</option>
                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                <option value="gpt-4">gpt-4</option>
                <option value="claude-3-sonnet">claude-3-sonnet</option>
            </select>
        </div>

        <div style="text-align: center;">
            <button onclick="testConnection()">ğŸ” æµ‹è¯•è¿æ¥</button>
            <button onclick="checkNetworkStatus()" class="btn-secondary">ğŸŒ æ£€æŸ¥ç½‘ç»œ</button>
            <button onclick="loadFromStorage()" class="btn-secondary">ğŸ“¥ åŠ è½½å·²ä¿å­˜é…ç½®</button>
        </div>

        <div id="result" class="result hidden"></div>

        <div class="status info" style="margin-top: 30px;">
            <strong>å¸¸è§è§£å†³æ–¹æ¡ˆï¼š</strong>
            <ul>
                <li><strong>æ£€æŸ¥APIå¯†é’¥ï¼š</strong> ç¡®ä¿å¯†é’¥æ ¼å¼æ­£ç¡®ä¸”æœªè¿‡æœŸ</li>
                <li><strong>ç½‘ç»œè¿æ¥ï¼š</strong> ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œæ— é˜²ç«å¢™é˜»æ­¢</li>
                <li><strong>APIæœåŠ¡çŠ¶æ€ï¼š</strong> æ£€æŸ¥APIæä¾›å•†æœåŠ¡æ˜¯å¦æ­£å¸¸</li>
                <li><strong>CORSé—®é¢˜ï¼š</strong> æŸäº›APIå¯èƒ½éœ€è¦ç‰¹æ®Šé…ç½®</li>
                <li><strong>ä»£ç†è®¾ç½®ï¼š</strong> å¦‚ä½¿ç”¨ä»£ç†ï¼Œè¯·æ£€æŸ¥ä»£ç†é…ç½®</li>
            </ul>
        </div>
    </div>

    <script>
        function updateDefaults() {
            const provider = document.getElementById('provider').value;
            const baseUrlInput = document.getElementById('baseUrl');
            const modelSelect = document.getElementById('model');
            
            const defaults = {
                deepseek: {
                    baseUrl: 'https://api.deepseek.com',
                    model: 'deepseek-chat'
                },
                openai: {
                    baseUrl: 'https://api.openai.com',
                    model: 'gpt-3.5-turbo'
                },
                anthropic: {
                    baseUrl: 'https://api.anthropic.com',
                    model: 'claude-3-sonnet'
                }
            };
            
            baseUrlInput.value = defaults[provider].baseUrl;
            modelSelect.value = defaults[provider].model;
        }

        function loadFromStorage() {
            const savedSettings = localStorage.getItem('chatSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('apiKey').value = settings.apiKey || '';
                document.getElementById('baseUrl').value = settings.baseUrl || '';
                document.getElementById('provider').value = settings.model || 'deepseek';
                document.getElementById('model').value = settings.modelVersion || 'deepseek-chat';
                showResult('å·²åŠ è½½ä¿å­˜çš„é…ç½®', 'success');
            } else {
                showResult('æœªæ‰¾åˆ°ä¿å­˜çš„é…ç½®', 'warning');
            }
        }

        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const provider = document.getElementById('provider').value;
            const model = document.getElementById('model').value;

            if (!apiKey) {
                showResult('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }

            const finalBaseUrl = baseUrl || (provider === 'deepseek' ? 'https://api.deepseek.com' : 'https://api.openai.com');
            
            showResult('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

            try {
                // æµ‹è¯•ç®€å•çš„æ¨¡å‹åˆ—è¡¨è¯·æ±‚
                const endpoint = provider === 'deepseek' 
                    ? `${finalBaseUrl}/models`
                    : `${finalBaseUrl}/v1/models`;

                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showResult(`âœ… è¿æ¥æˆåŠŸï¼APIé…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ ${model}`, 'success');
                } else {
                    const errorText = await response.text();
                    showResult(`âŒ è¿æ¥å¤±è´¥ï¼šHTTP ${response.status}\n${errorText}`, 'error');
                }
            } catch (error) {
                let errorMsg = `âŒ è¿æ¥æµ‹è¯•å¤±è´¥ï¼š${error.message}\n\n`;
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += 'å¯èƒ½çš„åŸå› ï¼š\n';
                    errorMsg += 'â€¢ ç½‘ç»œè¿æ¥é—®é¢˜\n';
                    errorMsg += 'â€¢ CORSç­–ç•¥é™åˆ¶\n';
                    errorMsg += 'â€¢ é˜²ç«å¢™é˜»æ­¢\n';
                    errorMsg += 'â€¢ APIæœåŠ¡ä¸å¯ç”¨\n\n';
                    errorMsg += 'å»ºè®®ï¼š\n';
                    errorMsg += '1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n';
                    errorMsg += '2. å°è¯•ä¸åŒçš„ç½‘ç»œç¯å¢ƒ\n';
                    errorMsg += '3. ç¡®è®¤APIå¯†é’¥æ­£ç¡®';
                }
                
                showResult(errorMsg, 'error');
            }
        }

        async function checkNetworkStatus() {
            showResult('æ­£åœ¨æ£€æŸ¥ç½‘ç»œçŠ¶æ€...', 'info');
            
            const tests = [
                { name: 'Google DNS', url: 'https://8.8.8.8' },
                { name: 'Cloudflare', url: 'https://1.1.1.1' },
                { name: 'DeepSeek API', url: 'https://api.deepseek.com' },
                { name: 'OpenAI API', url: 'https://api.openai.com' }
            ];
            
            let results = 'ç½‘ç»œè¿æ¥æµ‹è¯•ç»“æœï¼š\n\n';
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url, { 
                        method: 'HEAD', 
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    results += `âœ… ${test.name}: å¯è®¿é—®\n`;
                } catch (error) {
                    results += `âŒ ${test.name}: æ— æ³•è®¿é—® (${error.message})\n`;
                }
            }
            
            showResult(results, 'info');
        }

        function showResult(message, type) {
            const result = document.getElementById('result');
            result.className = `result ${type}`;
            result.textContent = message;
            result.classList.remove('hidden');
        }

        // åˆå§‹åŒ–
        updateDefaults();
        loadFromStorage();
    </script>
</body>
</html>